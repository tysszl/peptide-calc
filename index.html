<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Peptide Calculator</title>
  <meta name="description" content="Simple peptide reconstitution and dosing calculator. Get the right units every time.">
  <meta name="robots" content="noindex, nofollow">

  <!-- Fonts: Fraunces (elegant serif), Outfit (friendly sans), JetBrains Mono (precise numbers) -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Fraunces:opsz,wght@9..144,400;9..144,500;9..144,600&family=JetBrains+Mono:wght@400;500;600&family=Outfit:wght@300;400;500;600&display=swap" rel="stylesheet">

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Favicon -->
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><circle cx='50' cy='50' r='45' fill='%230D9488'/></svg>">

  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            stone: {
              50: '#FAFAF9',
              100: '#F5F5F4',
              150: '#EEEEEC',
              200: '#E7E5E4',
              300: '#D6D3D1',
              400: '#A8A29E',
              500: '#78716C',
              600: '#57534E',
              700: '#44403C',
              800: '#292524',
              900: '#1C1917'
            },
            teal: {
              50: '#F0FDFA',
              100: '#CCFBF1',
              200: '#99F6E4',
              300: '#5EEAD4',
              400: '#2DD4BF',
              500: '#14B8A6',
              600: '#0D9488',
              700: '#0F766E',
              800: '#115E59',
              900: '#134E4A'
            }
          },
          fontFamily: {
            serif: ['Fraunces', 'Georgia', 'serif'],
            sans: ['Outfit', 'system-ui', 'sans-serif'],
            mono: ['JetBrains Mono', 'monospace']
          }
        }
      }
    }
  </script>

  <style>
    * {
      box-sizing: border-box;
    }

    body {
      font-family: 'Outfit', system-ui, sans-serif;
      background: #FAFAF9;
      min-height: 100vh;
    }

    /* Typography utilities */
    .font-display {
      font-family: 'Fraunces', Georgia, serif;
      font-optical-sizing: auto;
    }

    .font-numbers {
      font-family: 'JetBrains Mono', monospace;
      font-feature-settings: 'tnum' on, 'lnum' on;
    }

    /* Subtle texture */
    .texture-dots {
      background-image: radial-gradient(circle, #D6D3D1 1px, transparent 1px);
      background-size: 24px 24px;
    }

    /* Card styling */
    .card {
      background: white;
      border: 1px solid #E7E5E4;
      box-shadow: 0 1px 3px rgba(0,0,0,0.04), 0 4px 12px rgba(0,0,0,0.02);
    }

    /* Prevent iOS zoom on input focus (requires 16px minimum) */
    input, select, textarea {
      font-size: 16px !important;
    }

    /* Prevent double-tap zoom on buttons */
    button {
      touch-action: manipulation;
    }

    /* Input styling */
    input[type="number"]::-webkit-inner-spin-button,
    input[type="number"]::-webkit-outer-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }
    input[type="number"] {
      -moz-appearance: textfield;
    }

    .input-field {
      background: #FAFAF9;
      border: 2px solid #E7E5E4;
      transition: all 0.2s ease;
    }

    .input-field:focus {
      outline: none;
      border-color: #0D9488;
      background: white;
    }

    .input-field:hover:not(:focus) {
      border-color: #D6D3D1;
    }

    /* Selection cards */
    .select-card {
      background: white;
      border: 2px solid #E7E5E4;
      transition: all 0.2s ease;
      cursor: pointer;
    }

    .select-card:hover {
      border-color: #A8A29E;
      transform: translateY(-1px);
    }

    .select-card.selected {
      border-color: #0D9488;
      background: #F0FDFA;
    }

    .select-card.selected .select-indicator {
      background: #0D9488;
      border-color: #0D9488;
    }

    .select-indicator {
      width: 20px;
      height: 20px;
      border: 2px solid #D6D3D1;
      border-radius: 50%;
      transition: all 0.2s ease;
      position: relative;
    }

    .select-indicator::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) scale(0);
      width: 8px;
      height: 8px;
      background: white;
      border-radius: 50%;
      transition: transform 0.2s ease;
    }

    .select-card.selected .select-indicator::after {
      transform: translate(-50%, -50%) scale(1);
    }

    /* Pill buttons */
    .pill-btn {
      background: white;
      border: 1.5px solid #E7E5E4;
      transition: all 0.15s ease;
    }

    .pill-btn:hover {
      border-color: #0D9488;
      color: #0D9488;
    }

    .pill-btn.active {
      background: #0D9488;
      border-color: #0D9488;
      color: white;
    }

    /* Progress bar */
    .progress-track {
      height: 3px;
      background: #E7E5E4;
      border-radius: 2px;
    }

    .progress-fill {
      height: 100%;
      background: #0D9488;
      border-radius: 2px;
      transition: width 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }

    /* Step transitions */
    .step-content {
      animation: fadeSlideIn 0.4s ease-out;
    }

    @keyframes fadeSlideIn {
      from {
        opacity: 0;
        transform: translateX(20px);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    /* Syringe styles */
    .syringe-liquid {
      transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
    }

    /* Result number animation */
    .result-number {
      transition: all 0.3s ease;
    }

    /* Button styles */
    .btn-primary {
      background: #0D9488;
      color: white;
      transition: all 0.2s ease;
    }

    .btn-primary:hover {
      background: #0F766E;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(13, 148, 136, 0.25);
    }

    .btn-primary:active {
      transform: translateY(0);
    }

    .btn-secondary {
      background: white;
      color: #57534E;
      border: 1.5px solid #E7E5E4;
      transition: all 0.2s ease;
    }

    .btn-secondary:hover {
      border-color: #A8A29E;
      color: #44403C;
    }

    /* Quick calc compact input */
    .compact-input {
      background: #FAFAF9;
      border: 1.5px solid #E7E5E4;
      transition: all 0.15s ease;
    }

    .compact-input:focus-within {
      border-color: #0D9488;
      background: white;
    }

    /* Dropdown */
    select {
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%2378716C'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 6px center;
      background-size: 14px;
      padding-right: 28px !important;
      cursor: pointer;
    }

    /* Scrollbar */
    ::-webkit-scrollbar {
      width: 6px;
    }
    ::-webkit-scrollbar-track {
      background: #F5F5F4;
    }
    ::-webkit-scrollbar-thumb {
      background: #D6D3D1;
      border-radius: 3px;
    }
    ::-webkit-scrollbar-thumb:hover {
      background: #A8A29E;
    }

    /* Focus visible */
    :focus-visible {
      outline: 2px solid #0D9488;
      outline-offset: 2px;
    }

    /* Recommendation badge */
    .badge-recommended {
      background: linear-gradient(135deg, #0D9488 0%, #0F766E 100%);
      color: white;
      font-size: 10px;
      font-weight: 600;
      letter-spacing: 0.05em;
      text-transform: uppercase;
      padding: 3px 8px;
      border-radius: 4px;
    }

    /* Warning/info states */
    .warning-soft {
      background: #FEF3C7;
      border: 1px solid #FCD34D;
      color: #92400E;
    }

    .info-soft {
      background: #F0FDFA;
      border: 1px solid #99F6E4;
      color: #115E59;
    }

    /* Tooltips */
    .tooltip {
      position: relative;
      cursor: help;
    }
    .tooltip::after {
      content: attr(data-tip);
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      background: #292524;
      color: white;
      padding: 6px 10px;
      border-radius: 6px;
      font-size: 12px;
      white-space: nowrap;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.2s, visibility 0.2s;
      z-index: 50;
      max-width: 200px;
      white-space: normal;
      text-align: center;
      line-height: 1.4;
    }
    .tooltip:hover::after {
      opacity: 1;
      visibility: visible;
    }
  </style>

  <script>
    // ============================================
    // PEPTIDE DATA
    // ============================================
    const PEPTIDES = {
      tirzepatide: {
        id: 'tirzepatide',
        name: 'Tirzepatide',
        aliases: ['Mounjaro', 'Zepbound'],
        category: 'GLP-1/GIP',
        description: 'Dual GLP-1/GIP agonist for weight management',
        commonVials: [5, 10, 15, 30],
        doseRanges: {
          micro: { min: 1, max: 2.5, label: 'Micro' },
          small: { min: 2.5, max: 5, label: 'Small' },
          medium: { min: 5, max: 10, label: 'Medium' },
          high: { min: 10, max: 15, label: 'High' }
        },
        quickDoses: [1.25, 2.5, 5, 7.5, 10, 15],
        defaultDose: 2.5
      },
      retatrutide: {
        id: 'retatrutide',
        name: 'Retatrutide',
        aliases: [],
        category: 'GLP-1/GIP/Glucagon',
        description: 'Triple agonist (investigational)',
        commonVials: [5, 10, 15],
        doseRanges: {
          micro: { min: 0.5, max: 2, label: 'Micro' },
          small: { min: 2, max: 4, label: 'Small' },
          medium: { min: 4, max: 8, label: 'Medium' },
          high: { min: 8, max: 12, label: 'High' }
        },
        quickDoses: [1, 2, 4, 6, 8, 12],
        defaultDose: 2
      },
      other: {
        id: 'other',
        name: 'Other',
        aliases: [],
        category: 'Custom',
        description: 'Enter custom peptide details',
        commonVials: [5, 10],
        doseRanges: {},
        quickDoses: [],
        defaultDose: 1
      }
    };

    // ============================================
    // CALCULATIONS
    // ============================================
    function calculateConcentration(vialMg, waterMl) {
      if (!vialMg || !waterMl || waterMl <= 0) return null;
      return vialMg / waterMl; // mg/mL
    }

    function calculateUnits(doseMg, concentrationMgPerMl) {
      if (!doseMg || !concentrationMgPerMl) return null;
      const ml = doseMg / concentrationMgPerMl;
      return Math.round(ml * 100 * 10) / 10; // units, 1 decimal
    }

    function calculateMl(doseMg, concentrationMgPerMl) {
      if (!doseMg || !concentrationMgPerMl) return null;
      return Math.round((doseMg / concentrationMgPerMl) * 1000) / 1000;
    }

    function calculateDosesPerVial(vialMg, doseMg) {
      if (!vialMg || !doseMg || doseMg <= 0) return null;
      return Math.floor(vialMg / doseMg);
    }

    // Smart recommendation: find best water amount for dose range
    // Goal: Use preferred concentration (5, 10, or 20 mg/mL) where min dose ≈ 10 units
    function recommendWater(vialMg, minDose, maxDose, syringeUnits = 50) {
      const preferredConcentrations = [5, 10, 20]; // Preferred clean concentrations
      const targetMinUnits = 10; // Target ~10 units for minimum dose

      // Calculate ideal concentration where minDose = 10 units
      // units = (dose / concentration) * 100, so concentration = dose * 10
      const idealConc = minDose * 10;

      // Find the best preferred concentration
      // We want concentration <= idealConc so that minDose gives >= 10 units
      // Sort by how close they get to 10 units (prefer closest to 10)
      const options = preferredConcentrations
        .map(conc => {
          const waterMl = vialMg / conc;
          const minUnits = (minDose / conc) * 100;
          const maxUnits = (maxDose / conc) * 100;
          return {
            concentration: conc,
            waterMl: Math.round(waterMl * 100) / 100,
            minUnits: Math.round(minUnits * 10) / 10,
            maxUnits: Math.round(maxUnits * 10) / 10,
            // How close is minUnits to our target of 10?
            distanceFromTarget: Math.abs(minUnits - targetMinUnits),
            // Is water amount reasonable?
            isValidWater: waterMl >= 0.5 && waterMl <= 5,
            // Does max dose fit in syringe?
            fitsInSyringe: maxUnits <= syringeUnits
          };
        })
        .filter(opt => opt.isValidWater) // Must have valid water amount
        .sort((a, b) => {
          // Prioritize options where max fits in syringe
          if (a.fitsInSyringe && !b.fitsInSyringe) return -1;
          if (!a.fitsInSyringe && b.fitsInSyringe) return 1;
          // Then sort by closest to 10 units for min dose
          return a.distanceFromTarget - b.distanceFromTarget;
        });

      if (options.length > 0) {
        const best = options[0];
        return {
          waterMl: best.waterMl,
          concentration: best.concentration,
          minUnits: Math.round(best.minUnits),
          maxUnits: Math.round(best.maxUnits),
          isIdeal: best.fitsInSyringe && best.minUnits >= 8
        };
      }

      // Fallback: use 2mL
      const fallbackWater = 2;
      const fallbackConc = vialMg / fallbackWater;
      return {
        waterMl: fallbackWater,
        concentration: fallbackConc,
        minUnits: Math.round((minDose / fallbackConc) * 100),
        maxUnits: Math.round((maxDose / fallbackConc) * 100),
        isIdeal: false
      };
    }

    // Simple water recommendation based on vial size only (for Advanced mode)
    // Returns water amount that creates a clean concentration (5, 10, or 20 mg/mL)
    function recommendWaterSimple(vialMg) {
      const allowedConcentrations = [10, 5, 20]; // Prefer 10, then 5, then 20

      for (const conc of allowedConcentrations) {
        const waterMl = vialMg / conc;
        // Only allow reasonable water volumes (0.5 to 3.5 mL for standard vials)
        if (waterMl >= 0.5 && waterMl <= 3.5) {
          return Math.round(waterMl * 100) / 100; // Round to 2 decimals
        }
      }

      // Fallback to 2mL if no clean concentration works
      return 2;
    }

    // ============================================
    // STORAGE
    // ============================================
    const Storage = {
      KEY: 'peptideCalc_v2',

      get() {
        try {
          return JSON.parse(localStorage.getItem(this.KEY)) || this.defaults();
        } catch {
          return this.defaults();
        }
      },

      save(data) {
        try {
          localStorage.setItem(this.KEY, JSON.stringify(data));
        } catch (e) {
          console.warn('Could not save to localStorage', e);
        }
      },

      defaults() {
        return {
          hasCompletedSetup: false,
          setups: [],
          lastUsed: null
        };
      }
    };

    // ============================================
    // SVG SYRINGE GENERATOR - Realistic Insulin Syringe
    // ============================================
    function generateSyringe(syringeSize, fillUnits, maxUnits) {
      const totalUnits = syringeSize === '0.5' ? 50 : 100;
      const majorTick = 10; // Labels at every 10 units for both syringe sizes
      const minorTick = syringeSize === '0.5' ? 5 : 5;
      const clampedUnits = Math.min(Math.max(fillUnits || 0, 0), totalUnits);
      const fillPct = (clampedUnits / totalUnits) * 100;

      const width = 340;
      const height = 85;
      const barrelX = 50;   // Connects directly with needle hub
      const barrelY = 30;
      const barrelW = 220;  // Barrel width adjusted for new layout
      const barrelH = 20;

      // Generate tick marks ON the barrel (like real syringes)
      // Numbers count UP from left to right: 0 at plunger, max at needle
      let ticks = '';
      const unitW = barrelW / totalUnits;
      for (let i = 0; i <= totalUnits; i++) {
        const x = barrelX + i * unitW;
        const isMajor = i % majorTick === 0;
        const isMid = !isMajor && i % minorTick === 0;
        const tickH = isMajor ? barrelH * 0.6 : (isMid ? barrelH * 0.4 : barrelH * 0.25);
        const strokeW = isMajor ? 0.8 : 0.5;

        // Ticks on barrel (from bottom edge going up)
        ticks += `<line x1="${x}" y1="${barrelY + barrelH}" x2="${x}" y2="${barrelY + barrelH - tickH}" stroke="#1a1a1a" stroke-width="${strokeW}"/>`;

        // Labels for major ticks (numbers count UP: 0 at plunger, max at needle)
        if (isMajor) {
          const label = i; // 0 at plunger (left), 50/100 at needle (right)
          ticks += `<text x="${x}" y="${barrelY + barrelH + 12}" text-anchor="middle" fill="#1a1a1a" font-size="8" font-family="JetBrains Mono, monospace" font-weight="600">${label}</text>`;
        }
      }

      // Fill calculation:
      // Numbers count UP from left to right (0 at plunger, max at needle)
      // Liquid fills from left (plunger) towards right (needle)
      // The indicator shows where to draw TO (reading the number on the barrel)
      const fillW = (fillPct / 100) * barrelW;
      // Indicator position: for 12.5 units on a 50-unit syringe, indicator is at 12.5/50 = 25% from the LEFT
      const indicatorX = barrelX + fillW;
      const exceedsSyringe = fillUnits > totalUnits;

      return `
        <svg viewBox="0 0 ${width} ${height}" class="w-full max-w-md" role="img" aria-label="Syringe showing ${clampedUnits} units">
          <defs>
            <!-- Liquid gradient (clear/light blue like actual peptide solution) -->
            <linearGradient id="liquid" x1="0%" y1="0%" x2="0%" y2="100%">
              <stop offset="0%" stop-color="#E0F7FA" stop-opacity="0.7"/>
              <stop offset="50%" stop-color="#B2EBF2" stop-opacity="0.8"/>
              <stop offset="100%" stop-color="#80DEEA" stop-opacity="0.7"/>
            </linearGradient>

            <!-- Warning liquid -->
            <linearGradient id="liquidWarn" x1="0%" y1="0%" x2="0%" y2="100%">
              <stop offset="0%" stop-color="#FFCDD2" stop-opacity="0.8"/>
              <stop offset="50%" stop-color="#EF9A9A" stop-opacity="0.9"/>
              <stop offset="100%" stop-color="#E57373" stop-opacity="0.8"/>
            </linearGradient>

            <!-- Barrel glass effect -->
            <linearGradient id="barrelGlass" x1="0%" y1="0%" x2="0%" y2="100%">
              <stop offset="0%" stop-color="#FFFFFF"/>
              <stop offset="20%" stop-color="#FAFAFA"/>
              <stop offset="80%" stop-color="#F0F0F0"/>
              <stop offset="100%" stop-color="#E8E8E8"/>
            </linearGradient>

            <!-- Orange plunger cap -->
            <linearGradient id="orangeCap" x1="0%" y1="0%" x2="100%" y2="0%">
              <stop offset="0%" stop-color="#F57C00"/>
              <stop offset="30%" stop-color="#FF9800"/>
              <stop offset="70%" stop-color="#FFB74D"/>
              <stop offset="100%" stop-color="#FF9800"/>
            </linearGradient>

            <!-- Orange cap end -->
            <linearGradient id="orangeCapEnd" x1="0%" y1="0%" x2="0%" y2="100%">
              <stop offset="0%" stop-color="#FFB74D"/>
              <stop offset="50%" stop-color="#FF9800"/>
              <stop offset="100%" stop-color="#F57C00"/>
            </linearGradient>

            <!-- Plunger rod -->
            <linearGradient id="plungerRod" x1="0%" y1="0%" x2="0%" y2="100%">
              <stop offset="0%" stop-color="#FAFAFA"/>
              <stop offset="30%" stop-color="#F5F5F5"/>
              <stop offset="70%" stop-color="#E0E0E0"/>
              <stop offset="100%" stop-color="#BDBDBD"/>
            </linearGradient>

            <!-- Black rubber gasket -->
            <linearGradient id="rubberGasket" x1="0%" y1="0%" x2="0%" y2="100%">
              <stop offset="0%" stop-color="#424242"/>
              <stop offset="50%" stop-color="#212121"/>
              <stop offset="100%" stop-color="#424242"/>
            </linearGradient>

            <!-- Needle hub (clear/white) -->
            <linearGradient id="needleHub" x1="0%" y1="0%" x2="100%" y2="0%">
              <stop offset="0%" stop-color="#F5F5F5"/>
              <stop offset="50%" stop-color="#FFFFFF"/>
              <stop offset="100%" stop-color="#E0E0E0"/>
            </linearGradient>

            <!-- Needle metal -->
            <linearGradient id="needleMetal" x1="0%" y1="0%" x2="0%" y2="100%">
              <stop offset="0%" stop-color="#E0E0E0"/>
              <stop offset="50%" stop-color="#BDBDBD"/>
              <stop offset="100%" stop-color="#9E9E9E"/>
            </linearGradient>

            <!-- Clip path for liquid inside barrel -->
            <clipPath id="barrelClip">
              <rect x="${barrelX}" y="${barrelY}" width="${barrelW}" height="${barrelH}" rx="3"/>
            </clipPath>
          </defs>

          <!-- NEEDLE TIP (left side, angled bevel) -->
          <path d="M2 ${barrelY + barrelH/2 + 1}
                   L10 ${barrelY + barrelH/2 - 0.75}
                   L10 ${barrelY + barrelH/2 + 0.75}
                   Z" fill="#757575"/>

          <!-- NEEDLE (metal) -->
          <line x1="10" y1="${barrelY + barrelH/2}" x2="37" y2="${barrelY + barrelH/2}" stroke="#9E9E9E" stroke-width="1.5" stroke-linecap="round"/>

          <!-- NEEDLE HUB (clear/white tapered) -->
          <path d="M37 ${barrelY + barrelH/2 - 1}
                   L50 ${barrelY + 4}
                   L50 ${barrelY + barrelH - 4}
                   L37 ${barrelY + barrelH/2 + 1}
                   Z" fill="url(#needleHub)" stroke="#BDBDBD" stroke-width="0.5"/>

          <!-- FINGER FLANGES (at needle end of barrel) -->
          <rect x="${barrelX - 3}" y="${barrelY - 6}" width="8" height="6" rx="1" fill="#F5F5F5" stroke="#BDBDBD" stroke-width="0.5"/>
          <rect x="${barrelX - 3}" y="${barrelY + barrelH}" width="8" height="6" rx="1" fill="#F5F5F5" stroke="#BDBDBD" stroke-width="0.5"/>

          <!-- BARREL (clear glass/plastic) -->
          <rect x="${barrelX}" y="${barrelY}" width="${barrelW}" height="${barrelH}" rx="3" fill="url(#barrelGlass)" stroke="#BDBDBD" stroke-width="1"/>

          <!-- Barrel highlight -->
          <rect x="${barrelX + 2}" y="${barrelY + 2}" width="${barrelW - 4}" height="5" rx="2" fill="rgba(255,255,255,0.6)"/>

          <!-- LIQUID FILL (from needle on LEFT to indicator position) -->
          ${fillPct > 0 ? `
            <g clip-path="url(#barrelClip)">
              <rect x="${barrelX}" y="${barrelY + 2}" width="${fillW}" height="${barrelH - 4}" fill="url(#${exceedsSyringe ? 'liquidWarn' : 'liquid'})" class="syringe-liquid"/>
            </g>
          ` : ''}

          <!-- BLACK RUBBER GASKET (inside barrel at plunger position - right side) -->
          <rect x="${barrelX + barrelW - 6}" y="${barrelY + 1}" width="6" height="${barrelH - 2}" rx="1" fill="url(#rubberGasket)"/>

          <!-- PLUNGER ROD (white/gray) -->
          <rect x="${barrelX + barrelW + 2}" y="${barrelY + 3}" width="25" height="${barrelH - 6}" rx="2" fill="url(#plungerRod)" stroke="#BDBDBD" stroke-width="0.5"/>

          <!-- ORANGE PLUNGER CAP (right end) -->
          <rect x="${barrelX + barrelW + 27}" y="${barrelY - 6}" width="26" height="${barrelH + 12}" rx="3" fill="url(#orangeCap)" stroke="#E65100" stroke-width="0.5"/>
          <!-- Cap end detail -->
          <ellipse cx="${barrelX + barrelW + 51}" cy="${barrelY + barrelH/2}" rx="2" ry="${barrelH/2 + 4}" fill="url(#orangeCapEnd)"/>

          <!-- TICK MARKS (on barrel) -->
          ${ticks}

          <!-- DOSE INDICATOR LINE -->
          ${fillPct > 0 && clampedUnits > 0 ? `
            <line x1="${indicatorX}" y1="${barrelY - 8}" x2="${indicatorX}" y2="${barrelY + barrelH + 16}" stroke="${exceedsSyringe ? '#D32F2F' : '#00897B'}" stroke-width="2" stroke-linecap="round"/>
            <polygon points="${indicatorX - 5},${barrelY - 8} ${indicatorX + 5},${barrelY - 8} ${indicatorX},${barrelY - 1}" fill="${exceedsSyringe ? '#D32F2F' : '#00897B'}"/>
          ` : ''}
        </svg>
      `;
    }

    // ============================================
    // ALPINE APP
    // ============================================
    function peptideApp() {
      return {
        // Wizard state
        showWizard: false,
        wizardStep: 1,

        // Form data
        peptideId: 'tirzepatide',
        customPeptideName: '',
        vialMg: 10,
        doseMin: 2.5,
        doseMax: 5,
        waterMl: 2,
        syringeSize: '0.5',
        currentDose: 2.5,

        // Saved data
        storage: null,
        savedSetups: [],
        activeSetupId: null,

        // UI state
        showWaterOptions: false,
        showSavedSetups: false,
        waterManuallySet: false,

        // Getters
        get peptide() {
          return PEPTIDES[this.peptideId] || PEPTIDES.other;
        },

        get concentration() {
          return calculateConcentration(this.vialMg, this.waterMl);
        },

        get units() {
          return calculateUnits(this.currentDose, this.concentration);
        },

        get ml() {
          return calculateMl(this.currentDose, this.concentration);
        },

        get dosesPerVial() {
          return calculateDosesPerVial(this.vialMg, this.currentDose);
        },

        get recommendation() {
          return recommendWater(this.vialMg, this.doseMin, this.doseMax, this.syringeSize === '0.5' ? 50 : 100);
        },

        get recommendedWater() {
          return recommendWaterSimple(this.vialMg);
        },

        get syringeSvg() {
          const maxUnits = this.syringeSize === '0.5' ? 50 : 100;
          return generateSyringe(this.syringeSize, this.units, maxUnits);
        },

        get exceedsSyringe() {
          const max = this.syringeSize === '0.5' ? 50 : 100;
          return this.units > max;
        },

        get unitsTooSmall() {
          return this.units > 0 && this.units < 5;
        },

        // Initialization
        init() {
          this.storage = Storage.get();
          this.savedSetups = this.storage.setups || [];

          // Restore last used settings if available
          if (this.storage.lastUsed) {
            this.restoreLastUsed();
            this.showWizard = false;
          } else {
            // First-time user: show wizard
            this.showWizard = true;
            this.wizardStep = 1;
          }

          // Watch for changes to save
          this.$watch('currentDose', () => this.saveLastUsed());
        },

        // Wizard navigation
        wizardNext() {
          if (this.wizardStep < 4) {
            this.wizardStep++;
            if (this.wizardStep === 4) {
              // Apply recommendation when reaching water step
              this.waterMl = this.recommendation.waterMl;
            }
          } else {
            // Complete wizard - auto collapse
            this.completeWizard();
          }
        },

        wizardBack() {
          if (this.wizardStep > 1) this.wizardStep--;
        },

        completeWizard() {
          this.showWizard = false;
          this.currentDose = this.doseMin;
          this.storage.hasCompletedSetup = true;
          this.saveLastUsed();
        },

        toggleWizard() {
          this.showWizard = !this.showWizard;
          if (this.showWizard && this.wizardStep > 4) {
            this.wizardStep = 1;
          }
        },

        // Peptide selection
        selectPeptide(id) {
          this.peptideId = id;
          const p = PEPTIDES[id];
          if (p) {
            this.vialMg = p.commonVials[1] || p.commonVials[0] || 10;
            this.currentDose = p.defaultDose || 1;
            if (p.doseRanges.small) {
              this.doseMin = p.doseRanges.small.min;
              this.doseMax = p.doseRanges.small.max;
            }
            // Auto-update water recommendation if not manually set
            if (!this.waterManuallySet) {
              this.waterMl = this.recommendedWater;
            }
          }
        },

        // Handle combo-box peptide input (Quick mode)
        handlePeptideInput(value) {
          // Check if input matches a known peptide name
          const match = Object.entries(PEPTIDES).find(([id, p]) =>
            p.name.toLowerCase() === value.toLowerCase()
          );

          if (match) {
            this.selectPeptide(match[0]);
          } else {
            // Custom peptide
            this.peptideId = 'other';
            this.customPeptideName = value;
          }
        },

        // Update water when vial changes
        onVialChange() {
          if (!this.waterManuallySet) {
            this.waterMl = recommendWaterSimple(this.vialMg);
          }
          this.saveLastUsed();
        },

        // Mark water as manually set when user edits it
        onWaterManualChange() {
          this.waterManuallySet = true;
          this.saveLastUsed();
        },

        // Apply a dose range preset
        applyDoseRange(range) {
          this.doseMin = range.min;
          this.doseMax = range.max;
        },

        // Check if current setup is already saved
        isCurrentSetupSaved() {
          return this.savedSetups.some(s =>
            s.peptideId === this.peptideId &&
            s.vialMg === this.vialMg &&
            s.waterMl === this.waterMl &&
            s.syringeSize === this.syringeSize
          );
        },

        // Save current setup
        saveSetup() {
          if (this.isCurrentSetupSaved()) return;

          // Format date as D/M/YY
          const now = new Date();
          const dateStr = `${now.getDate()}/${now.getMonth() + 1}/${String(now.getFullYear()).slice(-2)}`;

          const setup = {
            id: Date.now().toString(36),
            name: `${this.peptide.name} ${this.vialMg}mg – ${dateStr}`,
            peptideId: this.peptideId,
            vialMg: this.vialMg,
            waterMl: this.waterMl,
            syringeSize: this.syringeSize,
            currentDose: this.currentDose,
            createdAt: new Date().toISOString()
          };

          this.savedSetups.push(setup);
          this.storage.setups = this.savedSetups;
          this.storage.hasCompletedSetup = true;
          Storage.save(this.storage);
          this.activeSetupId = setup.id;
        },

        // Load a saved setup
        loadSetup(setup) {
          this.peptideId = setup.peptideId;
          this.vialMg = setup.vialMg;
          this.waterMl = setup.waterMl;
          this.syringeSize = setup.syringeSize;
          this.activeSetupId = setup.id;
          this.waterManuallySet = true; // Don't auto-update water when loading saved
          // Restore saved dose or use default
          if (setup.currentDose) {
            this.currentDose = setup.currentDose;
          } else {
            // Fallback for old saved setups without currentDose
            const p = PEPTIDES[setup.peptideId];
            this.currentDose = p?.defaultDose || 2.5;
          }
          // Set dose range based on peptide
          const p = PEPTIDES[setup.peptideId];
          if (p && p.doseRanges) {
            const firstRange = Object.values(p.doseRanges)[0];
            this.doseMin = firstRange?.min || 1;
            this.doseMax = firstRange?.max || 5;
          }
          this.showWizard = false;
          this.showSavedSetups = false;
        },

        // Delete setup
        deleteSetup(id) {
          this.savedSetups = this.savedSetups.filter(s => s.id !== id);
          this.storage.setups = this.savedSetups;
          Storage.save(this.storage);

          if (this.activeSetupId === id && this.savedSetups.length > 0) {
            this.loadSetup(this.savedSetups[0]);
          }
        },

        // Save last used for persistence
        saveLastUsed() {
          this.storage.lastUsed = {
            peptideId: this.peptideId,
            vialMg: this.vialMg,
            waterMl: this.waterMl,
            syringeSize: this.syringeSize,
            currentDose: this.currentDose
          };
          Storage.save(this.storage);
        },

        restoreLastUsed() {
          const lu = this.storage.lastUsed;
          if (lu) {
            this.peptideId = lu.peptideId || 'tirzepatide';
            this.vialMg = lu.vialMg || 10;
            this.waterMl = lu.waterMl || 2;
            this.syringeSize = lu.syringeSize || '0.5';
            this.currentDose = lu.currentDose || 2.5;
            this.waterManuallySet = true; // Don't auto-update on restore
          }
        },

        // Start new setup (reset wizard)
        startNewSetup() {
          this.showWizard = true;
          this.wizardStep = 1;
          this.waterManuallySet = false;
        },

        // Format helpers
        fmt(n, decimals = 1) {
          if (n === null || n === undefined) return '—';
          const fixed = Number(n).toFixed(decimals);
          return parseFloat(fixed).toString();
        },

        fmtConc(n) {
          if (!n) return '—';
          // Show nice round number if possible
          if (n === Math.round(n)) return n.toString();
          return n.toFixed(1);
        }
      };
    }
  </script>

  <!-- Alpine.js -->
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
</head>
<body>
  <div x-data="peptideApp()" x-init="init()" class="min-h-screen">
    <div class="max-w-xl mx-auto px-3 sm:px-4 py-3 sm:py-6">

      <!-- ==================== HEADER ==================== -->
      <header class="flex items-center justify-between mb-3">
        <h1 class="font-display text-lg sm:text-xl text-stone-800">Peptide Calculator</h1>
        <div class="flex items-center gap-2">
          <!-- Saved Setups Dropdown -->
          <div x-show="savedSetups.length > 0" class="relative">
            <button
              @click="showSavedSetups = !showSavedSetups"
              class="p-2 rounded-lg hover:bg-stone-100 text-stone-500 hover:text-stone-700 transition-colors"
              :class="showSavedSetups ? 'bg-stone-100 text-stone-700' : ''"
              title="Saved setups"
            >
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z"/>
              </svg>
            </button>
            <!-- Dropdown panel -->
            <div
              x-show="showSavedSetups"
              @click.away="showSavedSetups = false"
              x-transition
              class="absolute right-0 mt-1 w-64 bg-white rounded-xl shadow-lg border border-stone-200 py-2 z-50"
            >
              <div class="px-3 py-1.5 text-xs text-stone-400 uppercase tracking-wide">Saved Setups</div>
              <template x-for="setup in savedSetups" :key="setup.id">
                <div
                  class="group flex items-center justify-between px-3 py-2 hover:bg-stone-50 cursor-pointer"
                  :class="activeSetupId === setup.id ? 'bg-teal-50' : ''"
                  @click="loadSetup(setup)"
                >
                  <span class="text-sm text-stone-700" x-text="setup.name"></span>
                  <button
                    @click.stop="deleteSetup(setup.id)"
                    class="text-stone-300 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-opacity"
                    title="Delete"
                  >
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                  </button>
                </div>
              </template>
            </div>
          </div>
          <!-- Setup Steps Toggle -->
          <button
            @click="toggleWizard()"
            class="flex items-center gap-1 sm:gap-1.5 px-2 sm:px-3 py-1.5 rounded-lg text-xs sm:text-sm font-medium transition-colors"
            :class="showWizard ? 'bg-teal-500 text-white' : 'bg-stone-100 text-stone-600 hover:bg-stone-200'"
          >
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"/>
            </svg>
            <span class="hidden sm:inline" x-text="showWizard ? 'Hide' : 'Guided Setup'"></span>
            <span class="sm:hidden" x-text="showWizard ? 'Hide' : 'Setup'"></span>
          </button>
        </div>
      </header>

      <!-- ==================== WIZARD (Collapsible) ==================== -->
      <div x-show="showWizard" x-collapse class="mb-3 space-y-2">

        <!-- Step 1: Peptide Selection -->
        <div class="card rounded-xl overflow-hidden">
          <div
            class="px-3 sm:px-4 py-2.5 flex items-center justify-between cursor-pointer"
            :class="wizardStep === 1 ? 'bg-white' : 'bg-stone-50'"
            @click="wizardStep = 1"
          >
            <div class="flex items-center gap-2">
              <div class="w-6 h-6 rounded-full flex items-center justify-center text-xs font-medium"
                   :class="wizardStep > 1 ? 'bg-teal-500 text-white' : 'bg-stone-200 text-stone-600'">
                <span x-show="wizardStep <= 1">1</span>
                <svg x-show="wizardStep > 1" class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                </svg>
              </div>
              <div class="font-medium text-stone-800 text-sm">Peptide</div>
            </div>
            <div x-show="wizardStep > 1" class="text-sm text-stone-600" x-text="peptide.name"></div>
          </div>
          <div x-show="wizardStep === 1" x-collapse class="px-3 sm:px-4 pb-4 space-y-3">
            <p class="text-sm text-stone-500">Select the peptide you're using</p>
            <div class="flex flex-wrap gap-2">
              <template x-for="p in ['tirzepatide', 'retatrutide']" :key="p">
                <button
                  @click="selectPeptide(p)"
                  :class="peptideId === p ? 'active' : ''"
                  class="pill-btn px-4 py-2 rounded-lg text-sm font-medium"
                  x-text="PEPTIDES[p].name"
                ></button>
              </template>
              <!-- Custom peptide input -->
              <div class="relative">
                <input
                  type="text"
                  x-model="customPeptideName"
                  @focus="peptideId = 'other'"
                  @input="peptideId = 'other'"
                  placeholder="Custom"
                  class="pill-btn px-4 py-2 rounded-lg text-sm font-medium w-28 text-center focus:outline-none"
                  :class="peptideId === 'other' ? 'active' : ''"
                >
              </div>
            </div>
            <button @click="wizardNext()" class="btn-primary w-full py-2.5 rounded-lg font-medium">Continue</button>
          </div>
        </div>

        <!-- Step 2: Vial Size -->
        <div x-show="wizardStep >= 2" class="card rounded-xl overflow-hidden">
          <div
            class="px-3 sm:px-4 py-2.5 flex items-center justify-between cursor-pointer"
            :class="wizardStep === 2 ? 'bg-white' : 'bg-stone-50'"
            @click="wizardStep = 2"
          >
            <div class="flex items-center gap-2">
              <div class="w-6 h-6 rounded-full flex items-center justify-center text-xs font-medium"
                   :class="wizardStep > 2 ? 'bg-teal-500 text-white' : 'bg-stone-200 text-stone-600'">
                <span x-show="wizardStep <= 2">2</span>
                <svg x-show="wizardStep > 2" class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                </svg>
              </div>
              <div class="font-medium text-stone-800 text-sm">Vial Size</div>
            </div>
            <div x-show="wizardStep > 2" class="text-sm font-mono text-stone-600" x-text="vialMg + ' mg'"></div>
          </div>
          <div x-show="wizardStep === 2" x-collapse class="px-3 sm:px-4 pb-4 space-y-3">
            <p class="text-sm text-stone-500">Check your vial label for the total mg</p>
            <div class="flex flex-wrap items-center gap-2">
              <template x-for="size in peptide.commonVials" :key="size">
                <button
                  @click="vialMg = size"
                  :class="vialMg === size ? 'active' : ''"
                  class="pill-btn px-4 py-2 rounded-lg font-mono font-medium"
                >
                  <span x-text="size"></span><span class="text-stone-400 ml-1">mg</span>
                </button>
              </template>
              <!-- Custom vial input with label -->
              <div class="flex items-center gap-1 border-l border-stone-200 pl-2 ml-1">
                <span class="text-xs text-stone-400">or</span>
                <div
                  class="flex items-center gap-1 px-2 py-1.5 rounded-lg border-2 transition-colors"
                  :class="!peptide.commonVials.includes(vialMg) ? 'border-teal-500 bg-teal-50' : 'border-transparent'"
                >
                  <input type="number" x-model.number="vialMg" class="w-12 font-mono text-center text-sm bg-transparent focus:outline-none" min="1" step="1" placeholder="__">
                  <span class="text-stone-500 text-sm">mg</span>
                </div>
              </div>
            </div>
            <div class="flex gap-2">
              <button @click="wizardBack()" class="btn-secondary flex-1 py-2.5 rounded-lg font-medium">Back</button>
              <button @click="wizardNext()" class="btn-primary flex-[2] py-2.5 rounded-lg font-medium">Continue</button>
            </div>
          </div>
        </div>

        <!-- Step 3: Dose Range -->
        <div x-show="wizardStep >= 3" class="card rounded-xl overflow-hidden">
          <div
            class="px-3 sm:px-4 py-2.5 flex items-center justify-between cursor-pointer"
            :class="wizardStep === 3 ? 'bg-white' : 'bg-stone-50'"
            @click="wizardStep = 3"
          >
            <div class="flex items-center gap-2">
              <div class="w-6 h-6 rounded-full flex items-center justify-center text-xs font-medium"
                   :class="wizardStep > 3 ? 'bg-teal-500 text-white' : 'bg-stone-200 text-stone-600'">
                <span x-show="wizardStep <= 3">3</span>
                <svg x-show="wizardStep > 3" class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                </svg>
              </div>
              <div class="font-medium text-stone-800 text-sm">Dose Range</div>
            </div>
            <div x-show="wizardStep > 3" class="text-sm font-mono text-stone-600" x-text="doseMin + '–' + doseMax + ' mg'"></div>
          </div>
          <div x-show="wizardStep === 3" x-collapse class="px-3 sm:px-4 pb-4 space-y-3">
            <p class="text-sm text-stone-500">Select your typical dosing range to optimize dilution</p>
            <template x-if="Object.keys(peptide.doseRanges).length > 0">
              <div class="flex flex-wrap gap-2">
                <template x-for="(range, key) in peptide.doseRanges" :key="key">
                  <button
                    @click="applyDoseRange(range)"
                    :class="doseMin === range.min && doseMax === range.max ? 'active' : ''"
                    class="pill-btn px-3 py-1.5 rounded-lg text-sm"
                  >
                    <span x-text="range.label"></span>
                    <span class="text-stone-400 ml-1 text-xs">(<span x-text="range.min"></span>–<span x-text="range.max"></span>)</span>
                  </button>
                </template>
              </div>
            </template>
            <div class="bg-stone-50 rounded-lg p-3">
              <p class="text-xs text-stone-500 mb-2">Or enter custom range:</p>
              <div class="flex items-center gap-2">
                <div class="relative flex-1">
                  <input type="number" x-model.number="doseMin" class="input-field w-full rounded-lg px-3 py-2 font-mono text-center text-sm" min="0.01" step="0.25">
                  <span class="absolute right-2 top-1/2 -translate-y-1/2 text-stone-400 text-xs">mg</span>
                </div>
                <span class="text-stone-400 text-sm">to</span>
                <div class="relative flex-1">
                  <input type="number" x-model.number="doseMax" class="input-field w-full rounded-lg px-3 py-2 font-mono text-center text-sm" min="0.01" step="0.25">
                  <span class="absolute right-2 top-1/2 -translate-y-1/2 text-stone-400 text-xs">mg</span>
                </div>
              </div>
            </div>
            <div class="flex gap-2">
              <button @click="wizardBack()" class="btn-secondary flex-1 py-2.5 rounded-lg font-medium">Back</button>
              <button @click="wizardNext(); waterMl = recommendation.waterMl" class="btn-primary flex-[2] py-2.5 rounded-lg font-medium">Continue</button>
            </div>
          </div>
        </div>

        <!-- Step 4: BAC Water -->
        <div x-show="wizardStep >= 4" class="card rounded-xl overflow-hidden">
          <div
            class="px-3 sm:px-4 py-2.5 flex items-center justify-between cursor-pointer"
            :class="wizardStep === 4 ? 'bg-white' : 'bg-stone-50'"
            @click="wizardStep = 4"
          >
            <div class="flex items-center gap-2">
              <div class="w-6 h-6 rounded-full flex items-center justify-center text-xs font-medium bg-stone-200 text-stone-600">
                4
              </div>
              <div class="font-medium text-stone-800 text-sm">BAC Water</div>
            </div>
          </div>
          <div x-show="wizardStep === 4" x-collapse class="px-3 sm:px-4 pb-4 space-y-3">
            <div class="bg-teal-50 border border-teal-200 rounded-lg p-3">
              <div class="flex items-center gap-2 mb-1">
                <span class="font-medium text-teal-800 text-sm">Recommended:</span>
                <span class="font-mono font-semibold text-teal-700" x-text="recommendation.waterMl + ' mL'"></span>
              </div>
              <p class="text-xs text-teal-700">
                Gives <span class="font-mono font-medium" x-text="fmtConc(recommendation.concentration)"></span> mg/mL.
                Doses: <span class="font-mono" x-text="recommendation.minUnits"></span>–<span class="font-mono" x-text="recommendation.maxUnits"></span> units.
              </p>
            </div>
            <div>
              <button @click="if(showWaterOptions) waterMl = recommendation.waterMl; showWaterOptions = !showWaterOptions" class="text-sm text-stone-500 hover:text-stone-700 flex items-center gap-1">
                <span x-text="showWaterOptions ? 'Use recommended' : 'Choose different amount'"></span>
                <svg class="w-4 h-4 transition-transform" :class="showWaterOptions ? 'rotate-180' : ''" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                </svg>
              </button>
              <div x-show="showWaterOptions" x-collapse class="mt-3">
                <div class="flex items-center gap-2">
                  <div class="relative">
                    <input type="number" x-model.number="waterMl" class="input-field w-20 rounded-lg px-3 py-2 font-mono text-center" min="0.1" step="0.1" placeholder="2">
                  </div>
                  <span class="text-stone-600 font-medium">mL</span>
                  <span class="text-stone-400">→</span>
                  <span class="text-stone-600"><span class="font-mono" x-text="fmtConc(vialMg / waterMl)"></span> mg/mL</span>
                </div>
              </div>
            </div>
            <div class="flex gap-2">
              <button @click="wizardBack()" class="btn-secondary flex-1 py-2.5 rounded-lg font-medium">Back</button>
              <button @click="completeWizard()" class="btn-primary flex-[2] py-2.5 rounded-lg font-medium">Done</button>
            </div>
          </div>
        </div>

      </div>

      <!-- ==================== MAIN CALCULATOR CARD ==================== -->
      <div class="card rounded-xl overflow-hidden" :class="showWizard && wizardStep < 4 ? 'opacity-40 pointer-events-none' : ''">
        <!-- Config Row -->
        <div class="px-3 sm:px-4 py-2.5 bg-stone-50 border-b border-stone-100">
          <!-- Mobile: 2 rows, Desktop: 1 row -->
          <div class="flex flex-col sm:flex-row sm:items-center gap-2 sm:gap-4 text-sm">
            <!-- Row 1 on mobile: Peptide -->
            <div class="flex items-center gap-1.5">
              <span class="text-stone-500 text-xs sm:text-sm">Peptide</span>
              <div class="relative flex-1 sm:flex-none">
                <input
                  type="text"
                  list="peptide-list-main"
                  :value="peptideId === 'other' ? customPeptideName : PEPTIDES[peptideId]?.name"
                  @input="handlePeptideInput($event.target.value)"
                  @change="handlePeptideInput($event.target.value)"
                  placeholder="Select..."
                  class="bg-white border border-stone-200 rounded px-2 py-1.5 font-medium text-stone-700 focus:outline-none focus:border-teal-400 w-full sm:w-32"
                >
                <datalist id="peptide-list-main">
                  <template x-for="p in Object.keys(PEPTIDES).filter(k => k !== 'other')" :key="p">
                    <option :value="PEPTIDES[p].name"></option>
                  </template>
                </datalist>
              </div>
            </div>
            <!-- Row 2 on mobile: Vial + BAC Water -->
            <div class="flex items-center gap-3 sm:gap-4">
              <div class="hidden sm:block w-px h-6 bg-stone-200"></div>
              <div class="flex items-center gap-1.5">
                <span class="text-stone-500 text-xs sm:text-sm">Vial</span>
                <input type="number" x-model.number="vialMg" @input="onVialChange()"
                  class="bg-white border border-stone-200 rounded px-2 py-1.5 w-14 font-mono text-center focus:outline-none focus:border-teal-400" min="1" step="1">
                <span class="text-stone-500 text-xs sm:text-sm">mg</span>
              </div>
              <div class="w-px h-6 bg-stone-200"></div>
              <div class="flex items-center gap-1.5">
                <span class="text-stone-500 whitespace-nowrap text-xs sm:text-sm">BAC Water</span>
                <input type="number" x-model.number="waterMl" @input="onWaterManualChange()"
                  class="bg-white border border-stone-200 rounded px-2 py-1.5 w-14 font-mono text-center focus:outline-none focus:border-teal-400" min="0.1" step="0.1">
                <span class="text-stone-500 text-xs sm:text-sm">mL</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Main Calculator -->
        <div class="px-3 sm:px-4 py-4 space-y-4">
          <!-- Dose Row -->
          <div class="flex flex-col sm:flex-row items-center justify-center gap-4 sm:gap-6">
            <div class="flex flex-col items-center gap-1.5 w-48">
              <span class="text-xs text-stone-400 uppercase tracking-wide">Target Dose</span>
              <div class="flex items-center gap-2">
                <button @click="currentDose = Math.max(0.25, Math.round((currentDose - 0.25) * 4) / 4)"
                  class="w-10 h-10 sm:w-8 sm:h-8 rounded-full bg-stone-100 hover:bg-teal-100 flex items-center justify-center text-stone-500 hover:text-teal-600 text-xl sm:text-lg font-medium flex-shrink-0 transition-colors">−</button>
                <div class="flex items-baseline justify-center gap-1 bg-white border border-stone-200 rounded-lg py-1.5 w-32 focus-within:border-teal-400 focus-within:ring-2 focus-within:ring-teal-100">
                  <input type="number" x-model.number="currentDose"
                    class="w-20 text-left font-mono text-2xl font-semibold text-stone-800 bg-transparent focus:outline-none"
                    min="0.01" step="any" placeholder="2.5">
                  <span class="text-sm text-stone-400">mg</span>
                </div>
                <button @click="currentDose = Math.round((currentDose + 0.25) * 4) / 4"
                  class="w-10 h-10 sm:w-8 sm:h-8 rounded-full bg-stone-100 hover:bg-teal-100 flex items-center justify-center text-stone-500 hover:text-teal-600 text-xl sm:text-lg font-medium flex-shrink-0 transition-colors">+</button>
              </div>
              <!-- Quick Doses (under Target Dose) -->
              <div x-show="peptide.quickDoses && peptide.quickDoses.length >= 3" class="flex justify-center gap-2">
                <template x-for="d in peptide.quickDoses.slice(0, 3)" :key="d">
                  <button @click="currentDose = d"
                    :class="currentDose === d ? 'text-teal-600 font-medium' : 'text-stone-400 hover:text-teal-500'"
                    class="text-xs font-mono transition-colors"
                    x-text="d + 'mg'"></button>
                </template>
              </div>
            </div>

            <div class="flex flex-col items-center gap-1.5 w-full sm:w-40">
              <span class="text-xs text-stone-400 uppercase tracking-wide">Draw</span>
              <div class="flex flex-col items-center bg-teal-50 border border-teal-200 rounded-xl px-6 py-3 w-full max-w-48 sm:max-w-none">
                <div class="flex items-baseline gap-2">
                  <span class="text-teal-400">=</span>
                  <span class="font-mono font-bold text-3xl text-teal-600" x-text="fmt(units)"></span>
                  <span class="text-sm font-medium text-teal-700">units</span>
                </div>
                <span class="text-teal-400 text-sm"><span class="font-mono" x-text="fmt(ml, 3)"></span> mL</span>
              </div>
            </div>
          </div>

          <!-- Warnings -->
          <div x-show="exceedsSyringe" class="bg-amber-50 border border-amber-200 rounded-lg p-2 text-xs text-amber-800 text-center">
            ⚠️ Exceeds syringe capacity (<span x-text="syringeSize === '0.5' ? '50' : '100'"></span> units)
          </div>
          <div x-show="unitsTooSmall && !exceedsSyringe" class="bg-blue-50 border border-blue-200 rounded-lg p-2 text-xs text-blue-800 text-center">
            ℹ️ Small volume – may be hard to measure accurately
          </div>

          <!-- Syringe -->
          <div class="-mx-2 flex justify-center" x-html="syringeSvg"></div>
        </div>

        <!-- Footer -->
        <div class="px-3 sm:px-4 py-2.5 bg-stone-50 border-t border-stone-100">
          <div class="flex flex-col sm:flex-row sm:items-start sm:justify-between gap-3 sm:gap-0">
            <div class="flex flex-col gap-1">
              <span class="text-xs text-stone-400">Syringe</span>
              <div class="flex">
                <button @click="syringeSize = '0.5'" :class="syringeSize === '0.5' ? 'bg-teal-500 text-white border-teal-500' : 'bg-white text-stone-600 border-stone-200'"
                  class="px-2.5 py-1 rounded-l border font-mono text-xs transition-colors">0.5 mL</button>
                <button @click="syringeSize = '1.0'" :class="syringeSize === '1.0' ? 'bg-teal-500 text-white border-teal-500' : 'bg-white text-stone-600 border-stone-200'"
                  class="px-2.5 py-1 rounded-r border border-l-0 font-mono text-xs transition-colors">1.0 mL</button>
              </div>
            </div>
            <div class="grid grid-cols-4 gap-3 sm:flex sm:items-start sm:gap-5">
              <div class="flex flex-col gap-0.5 sm:gap-1 text-center">
                <span class="text-[10px] sm:text-xs text-stone-400">Concentration</span>
                <span class="font-mono font-medium text-stone-700 text-sm sm:text-base" x-text="fmtConc(concentration) + ' mg/mL'"></span>
              </div>
              <div class="flex flex-col gap-0.5 sm:gap-1 text-center">
                <span class="text-[10px] sm:text-xs text-stone-400">Units/mg</span>
                <span class="font-mono font-medium text-stone-700 text-sm sm:text-base" x-text="fmt(100 / concentration)"></span>
              </div>
              <div class="flex flex-col gap-0.5 sm:gap-1 text-center">
                <span class="text-[10px] sm:text-xs text-stone-400">Max Dose</span>
                <span class="font-mono font-medium text-stone-700 text-sm sm:text-base" x-text="fmt(parseFloat(syringeSize) * concentration) + ' mg'"></span>
              </div>
              <div class="flex flex-col gap-0.5 sm:gap-1 text-center">
                <span class="text-[10px] sm:text-xs text-stone-400">Doses/Vial</span>
                <span class="font-mono font-medium text-stone-700 text-sm sm:text-base" x-text="dosesPerVial || '—'"></span>
              </div>
            </div>
          </div>
        </div>

        <!-- Save Button -->
        <div class="px-4 py-2.5 border-t border-stone-100">
          <button
            @click="saveSetup()"
            x-show="!isCurrentSetupSaved()"
            class="w-full py-2 rounded-lg text-sm font-medium bg-stone-100 hover:bg-stone-200 text-stone-700 flex items-center justify-center gap-2 transition-colors"
          >
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z"/>
            </svg>
            Save this setup
          </button>
          <div x-show="isCurrentSetupSaved()" class="text-center text-sm text-teal-600 py-1">
            <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
            </svg>
            Setup saved
          </div>
        </div>
      </div>

    </div>
  </div>
</body>
</html>
