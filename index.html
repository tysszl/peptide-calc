<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Peptide Calculator</title>
  <meta name="description" content="Simple peptide reconstitution and dosing calculator. Get the right units every time.">
  <meta name="robots" content="noindex, nofollow">

  <!-- Fonts: Fraunces (elegant serif), Outfit (friendly sans), JetBrains Mono (precise numbers) -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Fraunces:opsz,wght@9..144,400;9..144,500;9..144,600&family=JetBrains+Mono:wght@400;500;600&family=Outfit:wght@300;400;500;600&display=swap" rel="stylesheet">

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Favicon -->
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><circle cx='50' cy='50' r='45' fill='%230D9488'/></svg>">

  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            stone: {
              50: '#FAFAF9',
              100: '#F5F5F4',
              150: '#EEEEEC',
              200: '#E7E5E4',
              300: '#D6D3D1',
              400: '#A8A29E',
              500: '#78716C',
              600: '#57534E',
              700: '#44403C',
              800: '#292524',
              900: '#1C1917'
            },
            teal: {
              50: '#F0FDFA',
              100: '#CCFBF1',
              200: '#99F6E4',
              300: '#5EEAD4',
              400: '#2DD4BF',
              500: '#14B8A6',
              600: '#0D9488',
              700: '#0F766E',
              800: '#115E59',
              900: '#134E4A'
            }
          },
          fontFamily: {
            serif: ['Fraunces', 'Georgia', 'serif'],
            sans: ['Outfit', 'system-ui', 'sans-serif'],
            mono: ['JetBrains Mono', 'monospace']
          }
        }
      }
    }
  </script>

  <style>
    * {
      box-sizing: border-box;
    }

    body {
      font-family: 'Outfit', system-ui, sans-serif;
      background: #FAFAF9;
      min-height: 100vh;
    }

    /* Typography utilities */
    .font-display {
      font-family: 'Fraunces', Georgia, serif;
      font-optical-sizing: auto;
    }

    /* Card styling */
    .card {
      background: white;
      border: 1px solid #E7E5E4;
      box-shadow: 0 1px 3px rgba(0,0,0,0.04), 0 4px 12px rgba(0,0,0,0.02);
    }

    /* Prevent iOS zoom on input focus (requires 16px minimum) */
    input, select, textarea {
      font-size: 16px !important;
    }

    /* Prevent double-tap zoom on buttons */
    button {
      touch-action: manipulation;
    }

    /* Input styling */
    input[type="number"]::-webkit-inner-spin-button,
    input[type="number"]::-webkit-outer-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }
    input[type="number"] {
      -moz-appearance: textfield;
    }

    .input-field {
      background: #FAFAF9;
      border: 2px solid #E7E5E4;
      transition: all 0.2s ease;
    }

    .input-field:focus {
      outline: none;
      border-color: #0D9488;
      background: white;
    }

    .input-field:hover:not(:focus) {
      border-color: #D6D3D1;
    }

    /* Selection cards */
    .select-card {
      background: white;
      border: 2px solid #E7E5E4;
      transition: all 0.2s ease;
      cursor: pointer;
    }

    .select-card:hover {
      border-color: #A8A29E;
      transform: translateY(-1px);
    }

    .select-card.selected {
      border-color: #0D9488;
      background: #F0FDFA;
    }

    .select-card.selected .select-indicator {
      background: #0D9488;
      border-color: #0D9488;
    }

    .select-indicator {
      width: 20px;
      height: 20px;
      border: 2px solid #D6D3D1;
      border-radius: 50%;
      transition: all 0.2s ease;
      position: relative;
    }

    .select-indicator::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) scale(0);
      width: 8px;
      height: 8px;
      background: white;
      border-radius: 50%;
      transition: transform 0.2s ease;
    }

    .select-card.selected .select-indicator::after {
      transform: translate(-50%, -50%) scale(1);
    }

    /* Pill buttons */
    .pill-btn {
      background: white;
      border: 1.5px solid #E7E5E4;
      transition: all 0.15s ease;
    }

    .pill-btn:hover {
      border-color: #0D9488;
      color: #0D9488;
    }

    .pill-btn.active {
      background: #0D9488;
      border-color: #0D9488;
      color: white;
    }

    /* Progress bar */
    .progress-track {
      height: 3px;
      background: #E7E5E4;
      border-radius: 2px;
    }

    .progress-fill {
      height: 100%;
      background: #0D9488;
      border-radius: 2px;
      transition: width 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }

    /* Step transitions */
    .step-content {
      animation: fadeSlideIn 0.4s ease-out;
    }

    @keyframes fadeSlideIn {
      from {
        opacity: 0;
        transform: translateX(20px);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    /* Syringe styles */
    .syringe-liquid {
      transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
    }

    /* Result number animation */
    .result-number {
      transition: all 0.3s ease;
    }

    /* Button styles */
    .btn-primary {
      background: #0D9488;
      color: white;
      transition: all 0.2s ease;
    }

    .btn-primary:hover {
      background: #0F766E;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(13, 148, 136, 0.25);
    }

    .btn-primary:active {
      transform: translateY(0);
    }

    .btn-secondary {
      background: white;
      color: #57534E;
      border: 1.5px solid #E7E5E4;
      transition: all 0.2s ease;
    }

    .btn-secondary:hover {
      border-color: #A8A29E;
      color: #44403C;
    }

    /* Quick calc compact input */
    .compact-input {
      background: #FAFAF9;
      border: 1.5px solid #E7E5E4;
      transition: all 0.15s ease;
    }

    .compact-input:focus-within {
      border-color: #0D9488;
      background: white;
    }

    /* Dropdown */
    select {
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%2378716C'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 6px center;
      background-size: 14px;
      padding-right: 28px !important;
      cursor: pointer;
    }

    /* Scrollbar */
    ::-webkit-scrollbar {
      width: 6px;
    }
    ::-webkit-scrollbar-track {
      background: #F5F5F4;
    }
    ::-webkit-scrollbar-thumb {
      background: #D6D3D1;
      border-radius: 3px;
    }
    ::-webkit-scrollbar-thumb:hover {
      background: #A8A29E;
    }

    /* Focus visible */
    :focus-visible {
      outline: 2px solid #0D9488;
      outline-offset: 2px;
    }

    /* Recommendation badge */
    .badge-recommended {
      background: linear-gradient(135deg, #0D9488 0%, #0F766E 100%);
      color: white;
      font-size: 10px;
      font-weight: 600;
      letter-spacing: 0.05em;
      text-transform: uppercase;
      padding: 3px 8px;
      border-radius: 4px;
    }

    /* Warning/info states */
    .warning-soft {
      background: #FEF3C7;
      border: 1px solid #FCD34D;
      color: #92400E;
    }

    .info-soft {
      background: #F0FDFA;
      border: 1px solid #99F6E4;
      color: #115E59;
    }

    /* Tooltips */
    .tooltip {
      position: relative;
      cursor: help;
    }
    .tooltip::after {
      content: attr(data-tip);
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      background: #292524;
      color: white;
      padding: 6px 10px;
      border-radius: 6px;
      font-size: 12px;
      white-space: nowrap;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.2s, visibility 0.2s;
      z-index: 50;
      max-width: 200px;
      white-space: normal;
      text-align: center;
      line-height: 1.4;
    }
    .tooltip:hover::after {
      opacity: 1;
      visibility: visible;
    }
  </style>

  <script>
    // ============================================
    // PEPTIDE DATA
    // ============================================
    const PEPTIDES = {
      tirzepatide: {
        id: 'tirzepatide',
        name: 'Tirzepatide',
        aliases: ['Mounjaro', 'Zepbound'],
        category: 'GLP-1/GIP',
        description: 'Dual GLP-1/GIP agonist for weight management',
        commonVials: [12, 18, 24, 34],
        doseRanges: {
          micro: { min: 1, max: 2.5, label: 'Micro' },
          small: { min: 2.5, max: 5, label: 'Small' },
          medium: { min: 5, max: 10, label: 'Medium' },
          high: { min: 10, max: 15, label: 'High' }
        },
        quickDoses: [1.25, 2.5, 5, 7.5, 10, 15],
        defaultDose: 2.5
      },
      retatrutide: {
        id: 'retatrutide',
        name: 'Retatrutide',
        aliases: [],
        category: 'GLP-1/GIP/Glucagon',
        description: 'Triple agonist (investigational)',
        commonVials: [7, 14, 24, 30],
        doseRanges: {
          micro: { min: 0.5, max: 2, label: 'Micro' },
          small: { min: 2, max: 4, label: 'Small' },
          medium: { min: 4, max: 8, label: 'Medium' },
          high: { min: 8, max: 12, label: 'High' }
        },
        quickDoses: [1, 2, 4, 6, 8, 12],
        defaultDose: 2
      },
      other: {
        id: 'other',
        name: 'Other',
        aliases: [],
        category: 'Custom',
        description: 'Enter custom peptide details',
        commonVials: [],
        doseRanges: {},
        quickDoses: [],
        defaultDose: 1
      }
    };

    // ============================================
    // BLEND PRESETS
    // ============================================
    const BLENDS = {
      'bpc-tb4': {
        id: 'bpc-tb4',
        name: 'BPC-157 + TB-4',
        description: 'Recovery & healing stack',
        components: [
          { name: 'BPC-157', defaultMg: 12 },
          { name: 'TB-4', defaultMg: 12 }
        ],
        quickDoses: [0.25, 0.5, 0.75],
        defaultDose: 0.5
      },
      'custom-blend': {
        id: 'custom-blend',
        name: 'Custom Combination',
        description: 'Enter your own combination',
        components: [
          { name: '', defaultMg: null },
          { name: '', defaultMg: null }
        ],
        quickDoses: [],
        defaultDose: 0.5
      }
    };

    // ============================================
    // CALCULATIONS
    // ============================================
    // Returns fresh empty blend components array (must be function to avoid shared references)
    function emptyBlendComponents() {
      return [{ name: '', mg: null }, { name: '', mg: null }];
    }

    function calculateConcentration(vialMg, waterMl) {
      if (!vialMg || !waterMl || waterMl <= 0) return null;
      return vialMg / waterMl; // mg/mL
    }

    function calculateUnits(doseMg, concentrationMgPerMl) {
      if (!doseMg || !concentrationMgPerMl) return null;
      const ml = doseMg / concentrationMgPerMl;
      return Math.round(ml * 100 * 10) / 10; // units, 1 decimal
    }

    function calculateMl(doseMg, concentrationMgPerMl) {
      if (!doseMg || !concentrationMgPerMl) return null;
      return Math.round((doseMg / concentrationMgPerMl) * 1000) / 1000;
    }

    function calculateDosesPerVial(vialMg, doseMg) {
      if (!vialMg || !doseMg || doseMg <= 0) return null;
      return Math.floor(vialMg / doseMg);
    }

    // Smart recommendation: find best water amount for dose range
    // Goal: Use preferred concentration (5, 10, or 20 mg/mL) where min dose ≈ 10 units
    function recommendWater(vialMg, minDose, maxDose, syringeUnits = 50) {
      const preferredConcentrations = [5, 10, 20]; // Preferred clean concentrations
      const targetMinUnits = 10; // Target ~10 units for minimum dose

      // Calculate ideal concentration where minDose = 10 units
      // units = (dose / concentration) * 100, so concentration = dose * 10
      const idealConc = minDose * 10;

      // Find the best preferred concentration
      // We want concentration <= idealConc so that minDose gives >= 10 units
      // Sort by how close they get to 10 units (prefer closest to 10)
      const options = preferredConcentrations
        .map(conc => {
          const waterMl = vialMg / conc;
          const minUnits = (minDose / conc) * 100;
          const maxUnits = (maxDose / conc) * 100;
          return {
            concentration: conc,
            waterMl: Math.round(waterMl * 100) / 100,
            minUnits: Math.round(minUnits * 10) / 10,
            maxUnits: Math.round(maxUnits * 10) / 10,
            // How close is minUnits to our target of 10?
            distanceFromTarget: Math.abs(minUnits - targetMinUnits),
            // Is water amount reasonable? (vials typically hold max 3mL)
            isValidWater: waterMl >= 0.5 && waterMl <= 3,
            // Does max dose fit in syringe?
            fitsInSyringe: maxUnits <= syringeUnits
          };
        })
        .filter(opt => opt.isValidWater) // Must have valid water amount
        .sort((a, b) => {
          // Prioritize options where max fits in syringe
          if (a.fitsInSyringe && !b.fitsInSyringe) return -1;
          if (!a.fitsInSyringe && b.fitsInSyringe) return 1;
          // Then sort by closest to 10 units for min dose
          return a.distanceFromTarget - b.distanceFromTarget;
        });

      if (options.length > 0) {
        const best = options[0];
        return {
          waterMl: best.waterMl,
          concentration: best.concentration,
          minUnits: Math.round(best.minUnits),
          maxUnits: Math.round(best.maxUnits),
          isIdeal: best.fitsInSyringe && best.minUnits >= 8
        };
      }

      // Fallback: use 2mL
      const fallbackWater = 2;
      const fallbackConc = vialMg / fallbackWater;
      return {
        waterMl: fallbackWater,
        concentration: fallbackConc,
        minUnits: Math.round((minDose / fallbackConc) * 100),
        maxUnits: Math.round((maxDose / fallbackConc) * 100),
        isIdeal: false
      };
    }

    // Simple water recommendation based on vial size only (for Advanced mode)
    // Returns water amount that creates a clean concentration (5, 10, or 20 mg/mL)
    function recommendWaterSimple(vialMg) {
      const allowedConcentrations = [10, 5, 20]; // Prefer 10, then 5, then 20

      for (const conc of allowedConcentrations) {
        const waterMl = vialMg / conc;
        // Only allow reasonable water volumes (0.5 to 3 mL for standard vials)
        if (waterMl >= 0.5 && waterMl <= 3) {
          return Math.round(waterMl * 100) / 100; // Round to 2 decimals
        }
      }

      // Fallback to 2mL if no clean concentration works
      return 2;
    }

    // ============================================
    // STORAGE
    // ============================================
    const Storage = {
      KEY: 'peptideCalc_v2',

      get() {
        try {
          return JSON.parse(localStorage.getItem(this.KEY)) || this.defaults();
        } catch {
          return this.defaults();
        }
      },

      save(data) {
        try {
          localStorage.setItem(this.KEY, JSON.stringify(data));
        } catch (e) {
          console.warn('Could not save to localStorage', e);
        }
      },

      defaults() {
        return {
          hasCompletedSetup: false,
          setups: [],
          lastUsed: null
        };
      }
    };

    // ============================================
    // SVG SYRINGE GENERATOR - Realistic Insulin Syringe
    // ============================================
    function generateSyringe(syringeSize, fillUnits, maxUnits) {
      const totalUnits = syringeSize === '0.5' ? 50 : 100;
      const majorTick = 10; // Labels at every 10 units for both syringe sizes
      const minorTick = syringeSize === '0.5' ? 5 : 5;
      const clampedUnits = Math.min(Math.max(fillUnits || 0, 0), totalUnits);
      const fillPct = (clampedUnits / totalUnits) * 100;

      const width = 340;
      const height = 85;
      const barrelX = 50;   // Connects directly with needle hub
      const barrelY = 30;
      const barrelW = 220;  // Barrel width adjusted for new layout
      const barrelH = 20;

      // Generate tick marks ON the barrel (like real syringes)
      // Numbers count UP from left to right: 0 at plunger, max at needle
      let ticks = '';
      const unitW = barrelW / totalUnits;
      for (let i = 0; i <= totalUnits; i++) {
        const x = barrelX + i * unitW;
        const isMajor = i % majorTick === 0;
        const isMid = !isMajor && i % minorTick === 0;
        const tickH = isMajor ? barrelH * 0.6 : (isMid ? barrelH * 0.4 : barrelH * 0.25);
        const strokeW = isMajor ? 0.8 : 0.5;

        // Ticks on barrel (from bottom edge going up)
        ticks += `<line x1="${x}" y1="${barrelY + barrelH}" x2="${x}" y2="${barrelY + barrelH - tickH}" stroke="#1a1a1a" stroke-width="${strokeW}"/>`;

        // Labels for major ticks (numbers count UP: 0 at plunger, max at needle)
        if (isMajor) {
          const label = i; // 0 at plunger (left), 50/100 at needle (right)
          ticks += `<text x="${x}" y="${barrelY + barrelH + 12}" text-anchor="middle" fill="#1a1a1a" font-size="8" font-family="JetBrains Mono, monospace" font-weight="600">${label}</text>`;
        }
      }

      // Fill calculation:
      // Numbers count UP from left to right (0 at plunger, max at needle)
      // Liquid fills from left (plunger) towards right (needle)
      // The indicator shows where to draw TO (reading the number on the barrel)
      const fillW = (fillPct / 100) * barrelW;
      // Indicator position: for 12.5 units on a 50-unit syringe, indicator is at 12.5/50 = 25% from the LEFT
      const indicatorX = barrelX + fillW;
      const exceedsSyringe = fillUnits > totalUnits;

      return `
        <svg viewBox="0 0 ${width} ${height}" class="w-full max-w-md" role="img" aria-label="Syringe showing ${clampedUnits} units">
          <defs>
            <!-- Liquid gradient (clear/light blue like actual peptide solution) -->
            <linearGradient id="liquid" x1="0%" y1="0%" x2="0%" y2="100%">
              <stop offset="0%" stop-color="#E0F7FA" stop-opacity="0.7"/>
              <stop offset="50%" stop-color="#B2EBF2" stop-opacity="0.8"/>
              <stop offset="100%" stop-color="#80DEEA" stop-opacity="0.7"/>
            </linearGradient>

            <!-- Warning liquid -->
            <linearGradient id="liquidWarn" x1="0%" y1="0%" x2="0%" y2="100%">
              <stop offset="0%" stop-color="#FFCDD2" stop-opacity="0.8"/>
              <stop offset="50%" stop-color="#EF9A9A" stop-opacity="0.9"/>
              <stop offset="100%" stop-color="#E57373" stop-opacity="0.8"/>
            </linearGradient>

            <!-- Barrel glass effect -->
            <linearGradient id="barrelGlass" x1="0%" y1="0%" x2="0%" y2="100%">
              <stop offset="0%" stop-color="#FFFFFF"/>
              <stop offset="20%" stop-color="#FAFAFA"/>
              <stop offset="80%" stop-color="#F0F0F0"/>
              <stop offset="100%" stop-color="#E8E8E8"/>
            </linearGradient>

            <!-- Orange plunger cap -->
            <linearGradient id="orangeCap" x1="0%" y1="0%" x2="100%" y2="0%">
              <stop offset="0%" stop-color="#F57C00"/>
              <stop offset="30%" stop-color="#FF9800"/>
              <stop offset="70%" stop-color="#FFB74D"/>
              <stop offset="100%" stop-color="#FF9800"/>
            </linearGradient>

            <!-- Orange cap end -->
            <linearGradient id="orangeCapEnd" x1="0%" y1="0%" x2="0%" y2="100%">
              <stop offset="0%" stop-color="#FFB74D"/>
              <stop offset="50%" stop-color="#FF9800"/>
              <stop offset="100%" stop-color="#F57C00"/>
            </linearGradient>

            <!-- Plunger rod -->
            <linearGradient id="plungerRod" x1="0%" y1="0%" x2="0%" y2="100%">
              <stop offset="0%" stop-color="#FAFAFA"/>
              <stop offset="30%" stop-color="#F5F5F5"/>
              <stop offset="70%" stop-color="#E0E0E0"/>
              <stop offset="100%" stop-color="#BDBDBD"/>
            </linearGradient>

            <!-- Black rubber gasket -->
            <linearGradient id="rubberGasket" x1="0%" y1="0%" x2="0%" y2="100%">
              <stop offset="0%" stop-color="#424242"/>
              <stop offset="50%" stop-color="#212121"/>
              <stop offset="100%" stop-color="#424242"/>
            </linearGradient>

            <!-- Needle hub (clear/white) -->
            <linearGradient id="needleHub" x1="0%" y1="0%" x2="100%" y2="0%">
              <stop offset="0%" stop-color="#F5F5F5"/>
              <stop offset="50%" stop-color="#FFFFFF"/>
              <stop offset="100%" stop-color="#E0E0E0"/>
            </linearGradient>

            <!-- Needle metal -->
            <linearGradient id="needleMetal" x1="0%" y1="0%" x2="0%" y2="100%">
              <stop offset="0%" stop-color="#E0E0E0"/>
              <stop offset="50%" stop-color="#BDBDBD"/>
              <stop offset="100%" stop-color="#9E9E9E"/>
            </linearGradient>

            <!-- Clip path for liquid inside barrel -->
            <clipPath id="barrelClip">
              <rect x="${barrelX}" y="${barrelY}" width="${barrelW}" height="${barrelH}" rx="3"/>
            </clipPath>
          </defs>

          <!-- NEEDLE TIP (left side, angled bevel) -->
          <path d="M2 ${barrelY + barrelH/2 + 1}
                   L10 ${barrelY + barrelH/2 - 0.75}
                   L10 ${barrelY + barrelH/2 + 0.75}
                   Z" fill="#757575"/>

          <!-- NEEDLE (metal) -->
          <line x1="10" y1="${barrelY + barrelH/2}" x2="37" y2="${barrelY + barrelH/2}" stroke="#9E9E9E" stroke-width="1.5" stroke-linecap="round"/>

          <!-- NEEDLE HUB (clear/white tapered) -->
          <path d="M37 ${barrelY + barrelH/2 - 1}
                   L50 ${barrelY + 4}
                   L50 ${barrelY + barrelH - 4}
                   L37 ${barrelY + barrelH/2 + 1}
                   Z" fill="url(#needleHub)" stroke="#BDBDBD" stroke-width="0.5"/>

          <!-- FINGER FLANGES (at needle end of barrel) -->
          <rect x="${barrelX - 3}" y="${barrelY - 6}" width="8" height="6" rx="1" fill="#F5F5F5" stroke="#BDBDBD" stroke-width="0.5"/>
          <rect x="${barrelX - 3}" y="${barrelY + barrelH}" width="8" height="6" rx="1" fill="#F5F5F5" stroke="#BDBDBD" stroke-width="0.5"/>

          <!-- BARREL (clear glass/plastic) -->
          <rect x="${barrelX}" y="${barrelY}" width="${barrelW}" height="${barrelH}" rx="3" fill="url(#barrelGlass)" stroke="#BDBDBD" stroke-width="1"/>

          <!-- Barrel highlight -->
          <rect x="${barrelX + 2}" y="${barrelY + 2}" width="${barrelW - 4}" height="5" rx="2" fill="rgba(255,255,255,0.6)"/>

          <!-- LIQUID FILL (from needle on LEFT to indicator position) -->
          ${fillPct > 0 ? `
            <g clip-path="url(#barrelClip)">
              <rect x="${barrelX}" y="${barrelY + 2}" width="${fillW}" height="${barrelH - 4}" fill="url(#${exceedsSyringe ? 'liquidWarn' : 'liquid'})" class="syringe-liquid"/>
            </g>
          ` : ''}

          <!-- BLACK RUBBER GASKET (inside barrel at plunger position - right side) -->
          <rect x="${barrelX + barrelW - 6}" y="${barrelY + 1}" width="6" height="${barrelH - 2}" rx="1" fill="url(#rubberGasket)"/>

          <!-- PLUNGER ROD (white/gray) -->
          <rect x="${barrelX + barrelW + 2}" y="${barrelY + 3}" width="25" height="${barrelH - 6}" rx="2" fill="url(#plungerRod)" stroke="#BDBDBD" stroke-width="0.5"/>

          <!-- ORANGE PLUNGER CAP (right end) -->
          <rect x="${barrelX + barrelW + 27}" y="${barrelY - 6}" width="26" height="${barrelH + 12}" rx="3" fill="url(#orangeCap)" stroke="#E65100" stroke-width="0.5"/>
          <!-- Cap end detail -->
          <ellipse cx="${barrelX + barrelW + 51}" cy="${barrelY + barrelH/2}" rx="2" ry="${barrelH/2 + 4}" fill="url(#orangeCapEnd)"/>

          <!-- TICK MARKS (on barrel) -->
          ${ticks}

          <!-- DOSE INDICATOR LINE -->
          ${fillPct > 0 && clampedUnits > 0 ? `
            <line x1="${indicatorX}" y1="${barrelY - 8}" x2="${indicatorX}" y2="${barrelY + barrelH + 16}" stroke="${exceedsSyringe ? '#D32F2F' : '#00897B'}" stroke-width="2" stroke-linecap="round"/>
            <polygon points="${indicatorX - 5},${barrelY - 8} ${indicatorX + 5},${barrelY - 8} ${indicatorX},${barrelY - 1}" fill="${exceedsSyringe ? '#D32F2F' : '#00897B'}"/>
          ` : ''}
        </svg>
      `;
    }

    // ============================================
    // ALPINE APP
    // ============================================
    function peptideApp() {
      return {
        // Wizard state
        showWizard: false,
        wizardStep: 1,

        // Form data
        peptideId: 'tirzepatide',
        customPeptideName: '',
        vialMg: 18,  // Default to Tirzepatide's common 18mg vial
        doseMin: 2.5,
        doseMax: 5,
        waterMl: 2,
        syringeSize: '0.5',
        currentDose: 2.5,

        // Blend data
        isBlend: false,
        blendId: null,
        blendComponents: emptyBlendComponents(),

        // Saved data
        storage: null,
        savedSetups: [],
        activeSetupId: null,

        // UI state
        showWaterOptions: false,
        showSavedSetups: false,
        waterManuallySet: false,

        // Getters
        get peptide() {
          return PEPTIDES[this.peptideId] || PEPTIDES.other;
        },

        // Blend computed properties
        get blend() {
          return this.blendId ? BLENDS[this.blendId] : null;
        },

        get blendTotalMg() {
          if (!this.isBlend) return null;
          return this.blendComponents.reduce((sum, c) => sum + (c.mg || 0), 0);
        },

        get blendConcentrations() {
          // Individual concentration per peptide in blend (mg/mL each)
          if (!this.isBlend || !this.waterMl) return null;
          return this.blendComponents.map(c => (c.mg || 0) / this.waterMl);
        },

        get blendDoses() {
          // Returns mg of each peptide for current draw, based on primary peptide's dose
          if (!this.isBlend || !this.blendConcentrations || !this.blendConcentrations[0]) return null;
          const primaryConc = this.blendConcentrations[0];
          const mlNeeded = this.currentDose / primaryConc;
          return this.blendComponents.map((c, i) => {
            return Math.round(this.blendConcentrations[i] * mlNeeded * 100) / 100;
          });
        },

        get concentration() {
          // For blends, use primary peptide concentration
          if (this.isBlend && this.blendConcentrations) {
            return this.blendConcentrations[0];
          }
          return calculateConcentration(this.vialMg, this.waterMl);
        },

        get units() {
          return calculateUnits(this.currentDose, this.concentration);
        },

        get ml() {
          return calculateMl(this.currentDose, this.concentration);
        },

        get dosesPerVial() {
          // For blends, calculate based on primary peptide since that's what we're dosing by
          const mgForCalc = this.isBlend && this.blendComponents[0]?.mg
            ? this.blendComponents[0].mg
            : this.vialMg;
          return calculateDosesPerVial(mgForCalc, this.currentDose);
        },

        get recommendation() {
          // For blends, use primary peptide's mg for calculation since dose is per primary
          const mgForCalc = this.isBlend && this.blendComponents[0]?.mg
            ? this.blendComponents[0].mg
            : this.vialMg;
          return recommendWater(mgForCalc, this.doseMin, this.doseMax, this.syringeSize === '0.5' ? 50 : 100);
        },

        get syringeSvg() {
          const maxUnits = this.syringeSize === '0.5' ? 50 : 100;
          return generateSyringe(this.syringeSize, this.units, maxUnits);
        },

        get exceedsSyringe() {
          const max = this.syringeSize === '0.5' ? 50 : 100;
          return this.units > max;
        },

        get unitsTooSmall() {
          return this.units > 0 && this.units < 5;
        },

        // Initialization
        init() {
          this.storage = Storage.get();
          this.savedSetups = this.storage.setups || [];

          // Restore last used settings if available
          if (this.storage.lastUsed) {
            this.restoreLastUsed();
            this.showWizard = false;
            this.wizardStep = 5; // Completed state so button shows "Edit Setup"
          } else {
            // First-time user: show wizard and initialize with default peptide
            this.showWizard = true;
            this.wizardStep = 1;
            this.selectPeptide('tirzepatide');
          }

          // Watch for changes to save
          this.$watch('currentDose', () => this.saveLastUsed());
        },

        // Wizard navigation
        wizardNext() {
          if (this.wizardStep < 4) {
            // For blends, skip step 2 (go from 1 to 3)
            if (this.isBlend && this.wizardStep === 1) {
              this.wizardStep = 3;
            } else {
              this.wizardStep++;
            }
            // Apply recommendation when reaching water step
            if (this.wizardStep === 4) {
              this.waterMl = this.recommendation.waterMl;
            }
          } else {
            // Complete wizard - auto collapse
            this.completeWizard();
          }
        },

        wizardBack() {
          if (this.wizardStep > 1) {
            // For blends, skip step 2 (go from 3 to 1)
            if (this.isBlend && this.wizardStep === 3) {
              this.wizardStep = 1;
            } else {
              this.wizardStep--;
            }
          }
        },

        completeWizard() {
          this.wizardStep = 5; // Completed state - shows all steps collapsed
          this.showWizard = false;
          this.currentDose = this.doseMin;
          this.storage.hasCompletedSetup = true;
          this.saveLastUsed();
        },

        toggleWizard() {
          this.showWizard = !this.showWizard;
        },

        // Peptide selection
        selectPeptide(id) {
          this.peptideId = id;
          // Exit blend mode when selecting a regular peptide
          this.isBlend = false;
          this.blendId = null;
          const p = PEPTIDES[id];
          if (p) {
            // For custom peptides with no commonVials, clear vialMg so input appears empty
            if (p.commonVials.length > 0) {
              this.vialMg = p.commonVials[1] || p.commonVials[0];
            } else {
              this.vialMg = null;
            }
            this.currentDose = p.defaultDose || 1;
            if (p.doseRanges.small) {
              this.doseMin = p.doseRanges.small.min;
              this.doseMax = p.doseRanges.small.max;
            }
            // Auto-update water recommendation if not manually set
            if (!this.waterManuallySet) {
              this.waterMl = recommendWaterSimple(this.vialMg);
            }
          }
        },

        // Blend selection
        selectBlend(id) {
          this.isBlend = true;
          this.blendId = id;
          this.peptideId = 'other'; // Use 'other' for blend mode
          const b = BLENDS[id];
          if (b) {
            this.blendComponents = b.components.map(c => ({
              name: c.name,
              mg: c.defaultMg
            }));
            // Set vial mg to total of components
            this.vialMg = this.blendTotalMg || null;
            // Set dose for blends (single dose, not a range)
            const defaultDose = b.defaultDose || 0.5;
            this.currentDose = defaultDose;
            this.doseMin = defaultDose;
            this.doseMax = defaultDose;
            // Auto-update water recommendation based on PRIMARY peptide mg
            const primaryMg = this.blendComponents[0]?.mg || this.blendTotalMg;
            if (!this.waterManuallySet && primaryMg) {
              this.waterMl = recommendWaterSimple(primaryMg);
            }
          }
        },

        // Exit blend mode and return to regular peptide
        exitBlendMode() {
          this.isBlend = false;
          this.blendId = null;
          this.blendComponents = emptyBlendComponents();
          this.selectPeptide('tirzepatide');
        },

        // Update a blend component (name or mg)
        updateBlendComponent(index, field, value) {
          this.blendComponents[index][field] = value;
          // Auto-update total vial mg
          this.vialMg = this.blendTotalMg || null;
          // Auto-update water recommendation based on PRIMARY peptide mg
          const primaryMg = this.blendComponents[0]?.mg || this.blendTotalMg;
          if (!this.waterManuallySet && primaryMg) {
            this.waterMl = recommendWaterSimple(primaryMg);
          }
        },

        // Handle combo-box peptide input (Quick mode)
        handlePeptideInput(value) {
          // Check if input matches a known peptide name
          const match = Object.entries(PEPTIDES).find(([id, p]) =>
            p.name.toLowerCase() === value.toLowerCase()
          );

          if (match) {
            this.selectPeptide(match[0]);
          } else {
            // Custom peptide
            this.peptideId = 'other';
            this.customPeptideName = value;
          }
        },

        // Update water when vial changes
        onVialChange() {
          if (!this.waterManuallySet) {
            this.waterMl = recommendWaterSimple(this.vialMg);
          }
          this.saveLastUsed();
        },

        // Mark water as manually set when user edits it
        onWaterManualChange() {
          this.waterManuallySet = true;
          this.saveLastUsed();
        },

        // Apply a dose range preset
        applyDoseRange(range) {
          this.doseMin = range.min;
          this.doseMax = range.max;
        },

        // Check if current setup is already saved
        isCurrentSetupSaved() {
          return this.savedSetups.some(s =>
            s.peptideId === this.peptideId &&
            s.vialMg === this.vialMg &&
            s.waterMl === this.waterMl &&
            s.syringeSize === this.syringeSize
          );
        },

        // Check if dose has changed from the loaded saved setup
        hasUnsavedDoseChange() {
          if (!this.activeSetupId) return false;
          const setup = this.savedSetups.find(s => s.id === this.activeSetupId);
          if (!setup) return false;
          return setup.currentDose !== this.currentDose;
        },

        // Get short name for a peptide
        getShortPeptideName(peptideId, customName) {
          const shortNames = {
            tirzepatide: 'Tirz',
            retatrutide: 'Reta'
          };
          if (peptideId === 'other') return customName || 'Custom';
          return shortNames[peptideId] || PEPTIDES[peptideId]?.name || peptideId;
        },

        // Generate setup name in format: "Tirz 18mg/1.8mL 12/18/25"
        generateSetupName() {
          const now = new Date();
          const dateStr = `${now.getMonth() + 1}/${now.getDate()}/${String(now.getFullYear()).slice(-2)}`;

          if (this.isBlend) {
            // "Tirz+Reta 10+12mg/2mL 12/18/25"
            const names = this.blendComponents.map(c => this.getShortPeptideName(c.peptideId, c.name)).join('+');
            const mgs = this.blendComponents.map(c => c.mg).join('+');
            return `${names} ${mgs}mg/${this.waterMl}mL ${dateStr}`;
          } else {
            // "Tirz 18mg/1.8mL 12/18/25"
            const shortName = this.getShortPeptideName(this.peptideId, this.customPeptideName);
            return `${shortName} ${this.vialMg}mg/${this.waterMl}mL ${dateStr}`;
          }
        },

        // Save current setup
        saveSetup() {
          if (this.isCurrentSetupSaved()) return;

          const setupName = this.generateSetupName();

          const setup = {
            id: Date.now().toString(36),
            name: setupName,
            peptideId: this.peptideId,
            customPeptideName: this.customPeptideName,
            vialMg: this.vialMg,
            waterMl: this.waterMl,
            syringeSize: this.syringeSize,
            currentDose: this.currentDose,
            doseMin: this.doseMin,
            doseMax: this.doseMax,
            createdAt: new Date().toISOString(),
            // Blend fields
            isBlend: this.isBlend,
            blendId: this.blendId,
            blendComponents: this.isBlend ? JSON.parse(JSON.stringify(this.blendComponents)) : null
          };

          this.savedSetups.push(setup);
          this.storage.setups = this.savedSetups;
          this.storage.hasCompletedSetup = true;
          Storage.save(this.storage);
          this.activeSetupId = setup.id;
        },

        // Update dose in an existing saved setup
        updateSetup() {
          const idx = this.savedSetups.findIndex(s => s.id === this.activeSetupId);
          if (idx === -1) return;

          this.savedSetups[idx].name = this.generateSetupName();
          this.savedSetups[idx].currentDose = this.currentDose;
          this.savedSetups[idx].doseMin = this.doseMin;
          this.savedSetups[idx].doseMax = this.doseMax;

          this.storage.setups = this.savedSetups;
          Storage.save(this.storage);
        },

        // Load a saved setup
        loadSetup(setup) {
          this.peptideId = setup.peptideId;
          this.customPeptideName = setup.customPeptideName || '';
          this.vialMg = setup.vialMg;
          this.waterMl = setup.waterMl;
          this.syringeSize = setup.syringeSize;
          this.activeSetupId = setup.id;
          this.waterManuallySet = true; // Don't auto-update water when loading saved
          this.wizardStep = 5; // Set to completed state so Edit Setup works
          this.showWizard = false;

          // Restore blend state if present
          if (setup.isBlend) {
            this.isBlend = true;
            this.blendId = setup.blendId;
            this.blendComponents = setup.blendComponents || emptyBlendComponents();
          } else {
            this.isBlend = false;
            this.blendId = null;
            this.blendComponents = emptyBlendComponents();
          }

          // Restore saved dose or use default
          if (setup.currentDose) {
            this.currentDose = setup.currentDose;
          } else {
            // Fallback for old saved setups without currentDose
            const p = PEPTIDES[setup.peptideId];
            this.currentDose = p?.defaultDose || 2.5;
          }

          // Restore dose range from saved setup, or use peptide defaults
          if (setup.doseMin !== undefined && setup.doseMax !== undefined) {
            this.doseMin = setup.doseMin;
            this.doseMax = setup.doseMax;
          } else {
            // Fallback for old saved setups without dose range
            const p = PEPTIDES[setup.peptideId];
            if (p && p.doseRanges) {
              const firstRange = Object.values(p.doseRanges)[0];
              this.doseMin = firstRange?.min || 1;
              this.doseMax = firstRange?.max || 5;
            }
          }

          this.showWizard = false;
          this.showSavedSetups = false;
        },

        // Delete setup
        deleteSetup(id) {
          this.savedSetups = this.savedSetups.filter(s => s.id !== id);
          this.storage.setups = this.savedSetups;
          Storage.save(this.storage);

          if (this.activeSetupId === id && this.savedSetups.length > 0) {
            this.loadSetup(this.savedSetups[0]);
          }
        },

        // Save last used for persistence
        saveLastUsed() {
          this.storage.lastUsed = {
            peptideId: this.peptideId,
            customPeptideName: this.customPeptideName,
            vialMg: this.vialMg,
            waterMl: this.waterMl,
            syringeSize: this.syringeSize,
            currentDose: this.currentDose,
            doseMin: this.doseMin,
            doseMax: this.doseMax,
            isBlend: this.isBlend,
            blendId: this.blendId,
            blendComponents: this.isBlend ? JSON.parse(JSON.stringify(this.blendComponents)) : null
          };
          Storage.save(this.storage);
        },

        restoreLastUsed() {
          const lu = this.storage.lastUsed;
          if (lu) {
            this.peptideId = lu.peptideId || 'tirzepatide';
            this.customPeptideName = lu.customPeptideName || '';
            this.vialMg = lu.vialMg || 10;
            this.waterMl = lu.waterMl || 2;
            this.syringeSize = lu.syringeSize || '0.5';
            this.currentDose = lu.currentDose || 2.5;
            this.doseMin = lu.doseMin || this.currentDose;
            this.doseMax = lu.doseMax || this.currentDose;
            this.waterManuallySet = true; // Don't auto-update on restore

            // Restore blend state if present
            if (lu.isBlend) {
              this.isBlend = true;
              this.blendId = lu.blendId;
              this.blendComponents = lu.blendComponents || emptyBlendComponents();
            }
          }
        },

        // Start new setup (reset wizard)
        startNewSetup() {
          this.showWizard = true;
          this.wizardStep = 1;
          this.waterManuallySet = false;
          // Reset blend state so we start fresh at peptide selection
          this.isBlend = false;
          this.blendId = null;
          // Default to Custom peptide
          this.peptideId = 'other';
          this.customPeptideName = '';
          this.vialMg = null;
        },

        // Format helpers
        fmt(n, decimals = 1) {
          if (n === null || n === undefined) return '—';
          const fixed = Number(n).toFixed(decimals);
          return parseFloat(fixed).toString();
        },

        fmtConc(n) {
          if (!n) return '—';
          // Show nice round number if possible
          if (n === Math.round(n)) return n.toString();
          return n.toFixed(1);
        }
      };
    }
  </script>

  <!-- Alpine.js -->
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
</head>
<body>
  <div x-data="peptideApp()" x-init="init()" class="min-h-screen">
    <div class="max-w-[600px] mx-auto px-3 sm:px-4 py-3 sm:py-6">

      <!-- ==================== HEADER ==================== -->
      <header class="flex flex-col min-[360px]:flex-row min-[360px]:items-center min-[360px]:justify-between gap-2 mb-3">
        <h1 class="font-display text-lg sm:text-xl text-stone-800 min-w-0">Peptide Calculator</h1>
        <div class="flex items-center gap-2 flex-shrink-0">
          <!-- Saved Setups Dropdown -->
          <div x-show="savedSetups.length > 0" class="relative">
            <button
              @click="showSavedSetups = !showSavedSetups"
              class="px-3 py-1.5 rounded-lg text-sm font-medium bg-stone-100 text-stone-600 hover:bg-stone-200 transition-colors flex items-center gap-1.5"
            >
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z"/>
              </svg>
              Setups
            </button>
            <!-- Dropdown panel - centered on screen, auto-width -->
            <div
              x-show="showSavedSetups"
              @click.away="showSavedSetups = false"
              x-transition.opacity.duration.150ms
              class="fixed inset-x-0 mx-auto top-16 w-fit min-w-48 max-w-80 bg-white rounded-xl shadow-lg border border-stone-200 py-2 z-50"
            >
              <div class="px-3 py-1.5 text-xs text-stone-400 uppercase tracking-wide">Saved Setups</div>
              <template x-for="setup in savedSetups" :key="setup.id">
                <div
                  class="group flex items-center justify-between px-3 py-2 hover:bg-stone-50 cursor-pointer"
                  :class="activeSetupId === setup.id ? 'bg-teal-50' : ''"
                  @click="loadSetup(setup)"
                >
                  <span class="text-sm text-stone-700 truncate mr-2" x-text="setup.name"></span>
                  <button
                    @click.stop="deleteSetup(setup.id)"
                    class="text-stone-400 hover:text-red-500 flex-shrink-0 p-1 -mr-1"
                    title="Delete"
                  >
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                  </button>
                </div>
              </template>
            </div>
          </div>
          <!-- Setup Steps Toggle -->
          <div class="flex items-center gap-2">
            <button
              x-show="wizardStep === 5"
              @click="startNewSetup()"
              class="px-3 py-1.5 rounded-lg text-sm font-medium bg-stone-100 text-stone-600 hover:bg-stone-200 transition-colors flex items-center gap-1.5"
            >
              New Setup
            </button>
            <button
              @click="toggleWizard()"
              class="px-3 py-1.5 rounded-lg text-sm font-medium transition-colors flex items-center gap-1.5"
              :class="showWizard ? 'bg-teal-500 text-white hover:bg-teal-600' : 'bg-stone-100 text-stone-600 hover:bg-stone-200'"
            >
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"/>
              </svg>
              <span x-text="showWizard ? 'Hide Guide' : 'Guide'"></span>
            </button>
          </div>
        </div>
      </header>

      <!-- ==================== WIZARD (Collapsible) ==================== -->
      <div x-show="showWizard" x-collapse class="mb-3 space-y-2">

        <!-- Step 1: Peptide Selection -->
        <div class="card rounded-xl overflow-hidden">
          <div
            class="px-3 sm:px-4 py-2.5 flex items-center justify-between cursor-pointer"
            :class="wizardStep === 1 ? 'bg-white' : 'bg-stone-50'"
            @click="wizardStep = wizardStep === 1 ? 5 : 1"
          >
            <div class="flex items-center gap-2">
              <div class="w-6 h-6 rounded-full flex items-center justify-center text-xs font-medium"
                   :class="wizardStep > 1 ? 'bg-teal-500 text-white' : 'bg-stone-200 text-stone-600'">
                <span x-show="wizardStep <= 1">1</span>
                <svg x-show="wizardStep > 1" class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                </svg>
              </div>
              <div class="font-medium text-stone-800 text-sm">Peptide</div>
            </div>
            <div x-show="wizardStep > 1" class="text-sm text-stone-600" x-text="isBlend ? blendComponents.map(c => (c.name || '?') + ' ' + (c.mg || '?') + 'mg').join(' + ') : peptide.name"></div>
          </div>
          <div x-show="wizardStep === 1" x-collapse class="px-3 sm:px-4 pb-4 space-y-3">
            <!-- Regular peptide selection (not blend mode) -->
            <template x-if="!isBlend">
              <div class="space-y-3">
                <p class="text-sm text-stone-500">Select the peptide you're using</p>
                <div class="flex flex-wrap gap-2">
                  <!-- Custom peptide input (first) -->
                  <div class="relative">
                    <input
                      type="text"
                      x-model="customPeptideName"
                      @focus="if(peptideId !== 'other') selectPeptide('other')"
                      @input="if(peptideId !== 'other') selectPeptide('other')"
                      placeholder="Custom"
                      class="pill-btn px-4 py-2 rounded-lg text-sm font-medium w-28 text-center focus:outline-none"
                      :class="peptideId === 'other' ? 'active placeholder:text-white/60' : ''"
                    >
                  </div>
                  <!-- Preset peptides -->
                  <template x-for="p in ['tirzepatide', 'retatrutide']" :key="p">
                    <button
                      @click="selectPeptide(p)"
                      :class="peptideId === p ? 'active' : ''"
                      class="pill-btn px-4 py-2 rounded-lg text-sm font-medium"
                      x-text="PEPTIDES[p].name"
                    ></button>
                  </template>
                  <!-- Combination button - visually distinct -->
                  <div class="border-l border-stone-200 pl-2 ml-1">
                    <button
                      @click="selectBlend('custom-blend')"
                      class="pill-btn px-4 py-2 rounded-lg text-sm font-medium border-dashed"
                    >Combination</button>
                  </div>
                </div>
                <button @click="wizardNext()" class="btn-primary w-full py-2.5 rounded-lg font-medium">Continue</button>
              </div>
            </template>

            <!-- Combo input mode -->
            <template x-if="isBlend">
              <div class="space-y-3">
                <div class="flex items-center gap-2">
                  <button @click="exitBlendMode()" class="text-stone-400 hover:text-stone-600">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                    </svg>
                  </button>
                  <p class="text-sm text-stone-500">Enter your combination peptides</p>
                </div>

                <!-- Blend inputs -->
                <div class="space-y-2">
                  <template x-for="(comp, idx) in blendComponents" :key="idx">
                    <div class="flex items-center gap-2">
                      <input
                        type="text"
                        :value="comp.name"
                        @input="updateBlendComponent(idx, 'name', $event.target.value)"
                        :placeholder="'Peptide ' + (idx + 1)"
                        class="w-28 px-3 py-2 rounded-lg border border-stone-200 text-sm focus:outline-none focus:ring-2 focus:ring-teal-500/50"
                      >
                      <div class="flex items-center">
                        <input
                          type="text" inputmode="decimal"
                          :value="comp.mg"
                          @change="updateBlendComponent(idx, 'mg', parseFloat($event.target.value) || null)"
                          @blur="updateBlendComponent(idx, 'mg', parseFloat($event.target.value) || null)"
                          placeholder="0"
                          class="w-14 px-2 py-2 rounded-l-lg border border-stone-200 text-sm font-mono text-center focus:outline-none focus:ring-2 focus:ring-teal-500/50"
                        >
                        <span class="bg-stone-100 border border-l-0 border-stone-200 rounded-r-lg px-2 py-2 text-stone-500 text-xs">mg</span>
                      </div>
                    </div>
                  </template>
                </div>

                <!-- Show total when valid -->
                <div x-show="blendTotalMg" class="text-sm text-stone-600 bg-stone-50 rounded-lg px-3 py-2">
                  Total: <span class="font-mono font-medium" x-text="blendTotalMg + ' mg'"></span>
                  <span class="text-stone-400" x-text="'(' + blendComponents.map(c => c.name || '?').join(' + ') + ')'"></span>
                </div>

                <button
                  @click="wizardNext()"
                  :disabled="!blendTotalMg || !blendComponents[0].name || !blendComponents[1].name"
                  class="btn-primary w-full py-2.5 rounded-lg font-medium disabled:opacity-50 disabled:cursor-not-allowed"
                >Continue</button>
              </div>
            </template>
          </div>
        </div>

        <!-- Step 2: Vial Size (hidden for blends) -->
        <div x-show="wizardStep >= 2 && !isBlend" class="card rounded-xl overflow-hidden">
          <div
            class="px-3 sm:px-4 py-2.5 flex items-center justify-between cursor-pointer"
            :class="wizardStep === 2 ? 'bg-white' : 'bg-stone-50'"
            @click="wizardStep = wizardStep === 2 ? 5 : 2"
          >
            <div class="flex items-center gap-2">
              <div class="w-6 h-6 rounded-full flex items-center justify-center text-xs font-medium"
                   :class="wizardStep > 2 ? 'bg-teal-500 text-white' : 'bg-stone-200 text-stone-600'">
                <span x-show="wizardStep <= 2">2</span>
                <svg x-show="wizardStep > 2" class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                </svg>
              </div>
              <div class="font-medium text-stone-800 text-sm">Vial Size</div>
            </div>
            <div x-show="wizardStep > 2" class="text-sm font-mono text-stone-600" x-text="vialMg + ' mg'"></div>
          </div>
          <div x-show="wizardStep === 2" x-collapse class="px-3 sm:px-4 pb-4 space-y-3">
            <!-- Regular peptide vial selection -->
            <template x-if="!isBlend">
              <div class="space-y-3">
                <p class="text-sm text-stone-500">Check your vial label for the total mg</p>
                <div class="flex flex-wrap items-center gap-2">
                  <template x-for="size in peptide.commonVials" :key="size">
                    <button
                      @click="vialMg = size"
                      :class="vialMg === size ? 'active' : ''"
                      class="pill-btn px-4 py-2 rounded-lg font-mono font-medium"
                    >
                      <span x-text="size"></span><span class="text-stone-400 ml-1">mg</span>
                    </button>
                  </template>
                  <!-- Custom vial input with label -->
                  <div class="flex items-center gap-1" :class="peptide.commonVials.length > 0 ? 'border-l border-stone-200 pl-2 ml-1' : ''">
                    <span x-show="peptide.commonVials.length > 0" class="text-xs text-stone-400">or</span>
                    <div
                      class="flex items-center gap-1 px-2 py-1.5 rounded-lg border-2 transition-colors"
                      :class="!peptide.commonVials.includes(vialMg) && vialMg ? 'border-teal-500 bg-teal-50' : 'border-transparent'"
                    >
                      <input type="text" inputmode="decimal"
                        :value="peptide.commonVials.includes(vialMg) ? '' : vialMg"
                        @change="vialMg = $event.target.value ? Number($event.target.value) : null"
                        @blur="vialMg = $event.target.value ? Number($event.target.value) : null"
                        class="w-12 font-mono text-center text-sm bg-transparent focus:outline-none placeholder:text-stone-300" placeholder="__">
                      <span class="text-stone-500 text-sm">mg</span>
                    </div>
                  </div>
                </div>
              </div>
            </template>

            <!-- Blend total display (auto-calculated) -->
            <template x-if="isBlend">
              <div class="space-y-3">
                <p class="text-sm text-stone-500">Total from blend components</p>
                <div class="bg-stone-50 rounded-lg p-3">
                  <div class="text-2xl font-mono font-semibold text-stone-800" x-text="blendTotalMg + ' mg'"></div>
                  <div class="text-sm text-stone-500 mt-1">
                    <template x-for="(comp, idx) in blendComponents" :key="idx">
                      <span>
                        <span x-text="comp.mg + 'mg ' + comp.name"></span>
                        <span x-show="idx < blendComponents.length - 1"> + </span>
                      </span>
                    </template>
                  </div>
                </div>
              </div>
            </template>

            <div class="flex gap-2">
              <button @click="wizardBack()" class="btn-secondary flex-1 py-2.5 rounded-lg font-medium">Back</button>
              <button @click="wizardNext()" class="btn-primary flex-[2] py-2.5 rounded-lg font-medium">Continue</button>
            </div>
          </div>
        </div>

        <!-- Step 3: Dose Range -->
        <div x-show="wizardStep >= 3" class="card rounded-xl overflow-hidden">
          <div
            class="px-3 sm:px-4 py-2.5 flex items-center justify-between cursor-pointer"
            :class="wizardStep === 3 ? 'bg-white' : 'bg-stone-50'"
            @click="wizardStep = wizardStep === 3 ? 5 : 3"
          >
            <div class="flex items-center gap-2">
              <div class="w-6 h-6 rounded-full flex items-center justify-center text-xs font-medium"
                   :class="wizardStep > 3 ? 'bg-teal-500 text-white' : 'bg-stone-200 text-stone-600'">
                <span x-show="wizardStep <= 3">3</span>
                <svg x-show="wizardStep > 3" class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                </svg>
              </div>
              <div class="font-medium text-stone-800 text-sm" x-text="isBlend ? 'Target Dose' : 'Dose Range'"></div>
            </div>
            <div x-show="wizardStep > 3" class="text-sm font-mono text-stone-600" x-text="isBlend ? currentDose + ' + ' + parseFloat(((currentDose / (blendComponents[0]?.mg || 1)) * (blendComponents[1]?.mg || 1)).toFixed(2)) + ' mg' : doseMin + '–' + doseMax + ' mg'"></div>
          </div>
          <div x-show="wizardStep === 3" x-collapse class="px-3 sm:px-4 pb-4 space-y-3">
            <!-- Regular peptides: Dose Range -->
            <template x-if="!isBlend">
              <div class="space-y-3">
                <p class="text-sm text-stone-500">Select your typical dosing range to optimize dilution</p>
                <template x-if="Object.keys(peptide.doseRanges).length > 0">
                  <div class="flex flex-wrap gap-2">
                    <template x-for="(range, key) in peptide.doseRanges" :key="key">
                      <button
                        @click="applyDoseRange(range)"
                        :class="doseMin === range.min && doseMax === range.max ? 'active' : ''"
                        class="pill-btn px-3 py-1.5 rounded-lg text-sm"
                      >
                        <span x-text="range.label"></span>
                        <span :class="doseMin === range.min && doseMax === range.max ? 'text-white/70' : 'text-stone-400'" class="ml-1 text-xs">(<span x-text="range.min"></span>–<span x-text="range.max"></span>)</span>
                      </button>
                    </template>
                  </div>
                </template>
                <div class="bg-stone-50 rounded-lg p-3">
                  <p class="text-xs text-stone-500 mb-2">Or enter custom range:</p>
                  <div class="flex items-center gap-2">
                    <div class="relative flex-1">
                      <input type="text" inputmode="decimal" :value="doseMin" @change="doseMin = parseFloat($event.target.value) || 0.5" @blur="doseMin = parseFloat($event.target.value) || 0.5" class="input-field w-full rounded-lg px-3 py-2 font-mono text-center text-sm">
                      <span class="absolute right-2 top-1/2 -translate-y-1/2 text-stone-400 text-xs">mg</span>
                    </div>
                    <span class="text-stone-400 text-sm">to</span>
                    <div class="relative flex-1">
                      <input type="text" inputmode="decimal" :value="doseMax" @change="doseMax = parseFloat($event.target.value) || 0.5" @blur="doseMax = parseFloat($event.target.value) || 0.5" class="input-field w-full rounded-lg px-3 py-2 font-mono text-center text-sm">
                      <span class="absolute right-2 top-1/2 -translate-y-1/2 text-stone-400 text-xs">mg</span>
                    </div>
                  </div>
                </div>
              </div>
            </template>

            <!-- Blends: Custom dose input only -->
            <template x-if="isBlend">
              <div class="space-y-3">
                <p class="text-sm text-stone-500">Enter target dose of each application</p>

                <!-- Primary peptide input -->
                <div class="flex items-center gap-2">
                  <div class="w-28 px-3 py-2 rounded-lg border border-stone-200 bg-stone-50 text-sm text-stone-700" x-text="blendComponents[0]?.name || 'Primary'"></div>
                  <div class="flex items-center">
                    <input type="text" inputmode="decimal"
                      x-model.number="currentDose"
                      @input="$nextTick(() => { doseMin = currentDose; doseMax = currentDose })"
                      class="w-14 px-2 py-2 rounded-l-lg border border-stone-200 text-sm font-mono text-center focus:outline-none focus:ring-2 focus:ring-teal-500/50"
                      placeholder="0.5">
                    <span class="bg-stone-100 border border-l-0 border-stone-200 rounded-r-lg px-2 py-2 text-stone-500 text-xs">mg</span>
                  </div>
                </div>

                <!-- Secondary peptide (calculated) -->
                <div class="flex items-center gap-2">
                  <div class="w-28 px-3 py-2 rounded-lg border border-stone-200 bg-stone-50 text-sm text-stone-700" x-text="blendComponents[1]?.name || 'Secondary'"></div>
                  <div class="flex items-center">
                    <div class="w-14 px-2 py-2 rounded-l-lg border border-stone-200 bg-stone-100 text-sm font-mono text-center">
                      <span x-show="!currentDose" class="text-stone-400">—</span>
                      <span x-show="currentDose" class="text-stone-700" x-text="parseFloat(((currentDose / (blendComponents[0]?.mg || 1)) * (blendComponents[1]?.mg || 1)).toFixed(2))"></span>
                    </div>
                    <span class="bg-stone-100 border border-l-0 border-stone-200 rounded-r-lg px-2 py-2 text-stone-500 text-xs">mg</span>
                  </div>
                </div>

                <p x-show="currentDose" class="text-xs text-stone-400">Secondary dose calculated from vial ratio</p>
              </div>
            </template>

            <div class="flex gap-2">
              <button @click="wizardBack()" class="btn-secondary flex-1 py-2.5 rounded-lg font-medium">Back</button>
              <button @click="wizardNext(); waterMl = recommendation.waterMl"
                :disabled="isBlend && !currentDose"
                :class="isBlend && !currentDose ? 'bg-stone-300 text-stone-500 cursor-not-allowed' : ''"
                class="btn-primary flex-[2] py-2.5 rounded-lg font-medium">Continue</button>
            </div>
          </div>
        </div>

        <!-- Step 4: BAC Water -->
        <div x-show="wizardStep >= 4" class="card rounded-xl overflow-hidden">
          <div
            class="px-3 sm:px-4 py-2.5 flex items-center justify-between cursor-pointer"
            :class="wizardStep === 4 ? 'bg-white' : 'bg-stone-50'"
            @click="wizardStep = wizardStep === 4 ? 5 : 4"
          >
            <div class="flex items-center gap-2">
              <div x-show="wizardStep > 4" class="w-6 h-6 rounded-full bg-teal-500 flex items-center justify-center">
                <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                </svg>
              </div>
              <div x-show="wizardStep === 4" class="w-6 h-6 rounded-full flex items-center justify-center text-xs font-medium bg-stone-200 text-stone-600">
                4
              </div>
              <div class="font-medium text-stone-800 text-sm">BAC Water</div>
            </div>
            <div x-show="wizardStep > 4" class="text-sm font-mono text-stone-600" x-text="waterMl + ' mL'"></div>
          </div>
          <div x-show="wizardStep === 4" x-collapse class="px-3 sm:px-4 pb-4 space-y-3">
            <p class="text-sm text-stone-500">Set the BAC water volume for reconstitution.</p>

            <!-- Current value row with editable input -->
            <div class="flex items-center flex-wrap gap-2 text-sm">
              <div class="flex items-center">
                <input type="text" inputmode="decimal"
                  :value="waterMl"
                  @input="waterManuallySet = true"
                  @change="waterMl = parseFloat($event.target.value) || waterMl; waterManuallySet = true"
                  @blur="waterMl = parseFloat($event.target.value) || waterMl"
                  class="bg-white border border-stone-200 rounded-l px-2 py-1 w-12 font-mono text-center text-stone-800 text-sm focus:outline-none focus:border-teal-400">
                <span class="bg-stone-100 border border-l-0 border-stone-200 rounded-r px-1.5 py-1 text-stone-500 text-xs">mL</span>
              </div>
              <span class="text-stone-400">→</span>
              <!-- Regular peptide concentration -->
              <span x-show="!isBlend" class="text-stone-600">
                <span class="font-mono" x-text="fmtConc(vialMg / waterMl)"></span> mg/mL
              </span>
              <!-- Blend concentrations -->
              <span x-show="isBlend" class="text-stone-600">
                <span class="font-mono" x-text="fmtConc(blendComponents[0]?.mg / waterMl)"></span> / <span class="font-mono" x-text="fmtConc(blendComponents[1]?.mg / waterMl)"></span> mg/mL
              </span>
              <span class="text-stone-400">→</span>
              <!-- Units display -->
              <span x-show="!isBlend && doseMin !== doseMax" class="text-stone-600">
                draws <span class="font-mono" x-text="Math.round((doseMin / (vialMg / waterMl)) * 100)"></span>–<span class="font-mono" x-text="Math.round((doseMax / (vialMg / waterMl)) * 100)"></span> units
              </span>
              <span x-show="!isBlend && doseMin === doseMax" class="text-stone-600">
                draws <span class="font-mono" x-text="Math.round((doseMin / (vialMg / waterMl)) * 100)"></span> units
              </span>
              <span x-show="isBlend" class="text-stone-600">
                draws <span class="font-mono" x-text="Math.round((currentDose / (blendComponents[0]?.mg / waterMl)) * 100)"></span> units
              </span>
            </div>

            <!-- Warning for volume exceeding vial capacity -->
            <div x-show="waterMl > 3.5" class="flex items-start gap-2 text-sm bg-amber-50 border border-amber-200 rounded-lg p-2">
              <svg class="w-4 h-4 text-amber-500 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
              </svg>
              <span class="text-amber-700">Standard 3mL vials hold a maximum of 3.5mL. Ensure your vial can accommodate this volume.</span>
            </div>

            <!-- Recommended row (shown when different from current) -->
            <div x-show="waterMl !== recommendation.waterMl" class="flex items-center flex-wrap gap-2 text-sm bg-teal-50 border border-teal-200 rounded-lg p-2">
              <span class="text-teal-700">Recommended:</span>
              <span class="font-mono text-teal-700" x-text="recommendation.waterMl + ' mL'"></span>
              <span class="text-teal-400">→</span>
              <span x-show="!isBlend" class="text-teal-600">
                <span class="font-mono" x-text="fmtConc(recommendation.concentration)"></span> mg/mL
              </span>
              <span x-show="isBlend" class="text-teal-600">
                <span class="font-mono" x-text="fmtConc(blendComponents[0]?.mg / recommendation.waterMl)"></span> / <span class="font-mono" x-text="fmtConc(blendComponents[1]?.mg / recommendation.waterMl)"></span> mg/mL
              </span>
              <span class="text-teal-400">→</span>
              <span x-show="!isBlend && doseMin !== doseMax" class="text-teal-600">
                draws <span class="font-mono" x-text="recommendation.minUnits"></span>–<span class="font-mono" x-text="recommendation.maxUnits"></span> units
              </span>
              <span x-show="!isBlend && doseMin === doseMax" class="text-teal-600">
                draws <span class="font-mono" x-text="recommendation.minUnits"></span> units
              </span>
              <span x-show="isBlend" class="text-teal-600">
                draws <span class="font-mono" x-text="recommendation.minUnits"></span> units
              </span>
              <button
                @click="waterMl = recommendation.waterMl; waterManuallySet = false"
                class="text-xs text-teal-600 hover:text-teal-800 underline ml-auto"
              >Use this</button>
            </div>

            <div class="flex gap-2">
              <button @click="wizardBack()" class="btn-secondary flex-1 py-2.5 rounded-lg font-medium">Back</button>
              <button @click="completeWizard()" class="btn-primary flex-[2] py-2.5 rounded-lg font-medium">Done</button>
            </div>
          </div>
        </div>

        
      </div>

      <!-- ==================== MAIN CALCULATOR CARD ==================== -->
      <div class="card rounded-xl overflow-hidden" :class="showWizard && wizardStep < 4 ? 'opacity-40 pointer-events-none' : ''">
        <!-- Config Row -->
        <div class="px-3 sm:px-4 py-2 bg-stone-50 border-b border-stone-100">
          <!-- Label row (hidden for blends - they have integrated layout) -->
          <div x-show="!isBlend" class="flex items-center justify-between mb-1">
            <span class="text-xs text-stone-500 font-medium">Vial setup</span>
            <!-- Save/Update indicator -->
            <button
              @click="saveSetup()"
              x-show="!isCurrentSetupSaved()"
              class="text-xs text-stone-400 hover:text-teal-600 flex items-center gap-1 transition-colors"
            >
              <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z"/>
              </svg>
              Save as new
            </button>
            <button
              @click="updateSetup()"
              x-show="isCurrentSetupSaved() && hasUnsavedDoseChange()"
              class="text-xs text-stone-400 hover:text-teal-600 flex items-center gap-1 transition-colors"
            >
              <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
              </svg>
              Save changes
            </button>
            <div x-show="isCurrentSetupSaved() && !hasUnsavedDoseChange()" class="text-xs text-teal-600 flex items-center gap-1">
              <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
              </svg>
              Saved
            </div>
          </div>
          <!-- Regular peptide: sentence format -->
          <div x-show="!isBlend" class="flex items-center justify-center flex-wrap gap-1.5 text-sm text-stone-600">
            <div class="flex items-center">
              <input type="text" inputmode="decimal"
                :value="vialMg"
                @change="vialMg = parseFloat($event.target.value) || vialMg; onVialChange();"
                @blur="vialMg = parseFloat($event.target.value) || vialMg; onVialChange();"
                class="bg-white border border-stone-200 rounded-l px-2 py-1 w-10 font-mono text-center text-stone-800 text-sm focus:outline-none focus:border-teal-400">
              <span class="bg-stone-100 border border-l-0 border-stone-200 rounded-r px-1.5 py-1 text-stone-500 text-xs">mg</span>
            </div>
            <div class="relative">
              <input type="text" list="peptide-list"
                :value="peptideId === 'other' ? customPeptideName : peptide.name"
                @input="handlePeptideInput($event.target.value)"
                @change="handlePeptideInput($event.target.value)"
                placeholder="Peptide"
                class="bg-white border border-stone-200 rounded px-2 py-1 text-stone-800 text-sm focus:outline-none focus:border-teal-400 w-28">
            </div>
            <datalist id="peptide-list">
              <template x-for="p in Object.keys(PEPTIDES).filter(k => k !== 'other')" :key="p">
                <option :value="PEPTIDES[p].name"></option>
              </template>
            </datalist>
            <span class="text-stone-400">in</span>
            <div class="flex items-center">
              <input type="text" inputmode="decimal"
                :value="waterMl"
                @change="waterMl = parseFloat($event.target.value) || waterMl; onWaterManualChange();"
                @blur="waterMl = parseFloat($event.target.value) || waterMl; onWaterManualChange();"
                class="bg-white border border-stone-200 rounded-l px-2 py-1 w-12 font-mono text-center text-stone-800 text-sm focus:outline-none focus:border-teal-400">
              <span class="bg-stone-100 border border-l-0 border-stone-200 rounded-r px-1.5 py-1 text-stone-500 text-xs">mL</span>
            </div>
          </div>

          <!-- Blend: integrated layout with label and save inline on wide, stacked on narrow -->
          <div x-show="isBlend" class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-1 sm:gap-2 text-sm text-stone-600">
            <!-- Label row (own row on narrow, inline on wide) -->
            <div class="flex items-center justify-between sm:hidden mb-1">
              <span class="text-xs text-stone-500 font-medium">Vial setup</span>
              <!-- Save indicator for narrow -->
              <button
                @click="saveSetup()"
                x-show="!isCurrentSetupSaved()"
                class="text-xs text-stone-400 hover:text-teal-600 flex items-center gap-1 transition-colors"
              >
                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z"/>
                </svg>
                Save as new
              </button>
              <button
                @click="updateSetup()"
                x-show="isCurrentSetupSaved() && hasUnsavedDoseChange()"
                class="text-xs text-stone-400 hover:text-teal-600 flex items-center gap-1 transition-colors"
              >
                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                </svg>
                Save changes
              </button>
              <div x-show="isCurrentSetupSaved() && !hasUnsavedDoseChange()" class="text-xs text-teal-600 flex items-center gap-1">
                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                </svg>
                Saved
              </div>
            </div>

            <!-- Left: Label (hidden on narrow, shown on wide) -->
            <span class="hidden sm:block text-xs text-stone-500 font-medium self-start pt-1">Vial setup</span>

            <!-- Center: Stacked peptides + water -->
            <div class="flex items-center justify-center sm:justify-start gap-3">
              <!-- Stacked peptide rows -->
              <div class="flex flex-col gap-1">
                <template x-for="(comp, idx) in blendComponents" :key="idx">
                  <div class="flex items-center gap-1.5">
                    <div class="flex items-center">
                      <input type="text" inputmode="decimal"
                        :value="comp.mg"
                        @change="updateBlendComponent(idx, 'mg', parseFloat($event.target.value) || null)"
                        @blur="updateBlendComponent(idx, 'mg', parseFloat($event.target.value) || null)"
                        placeholder="mg"
                        class="bg-white border border-stone-200 rounded-l px-2 py-1 w-10 font-mono text-center text-stone-800 text-sm focus:outline-none focus:border-teal-400">
                      <span class="bg-stone-100 border border-l-0 border-stone-200 rounded-r px-1.5 py-1 text-stone-500 text-xs">mg</span>
                    </div>
                    <input type="text"
                      :value="comp.name"
                      @change="updateBlendComponent(idx, 'name', $event.target.value)"
                      @blur="updateBlendComponent(idx, 'name', $event.target.value)"
                      placeholder="Peptide"
                      class="bg-white border border-stone-200 rounded px-2 py-1 text-stone-800 text-sm focus:outline-none focus:border-teal-400 w-20">
                  </div>
                </template>
              </div>
              <!-- Water volume -->
              <div class="flex items-center gap-1.5">
                <span class="text-stone-400">in</span>
                <div class="flex items-center">
                  <input type="text" inputmode="decimal"
                    :value="waterMl"
                    @change="waterMl = parseFloat($event.target.value) || waterMl; onWaterManualChange();"
                    @blur="waterMl = parseFloat($event.target.value) || waterMl; onWaterManualChange();"
                    class="bg-white border border-stone-200 rounded-l px-2 py-1 w-12 font-mono text-center text-stone-800 text-sm focus:outline-none focus:border-teal-400">
                  <span class="bg-stone-100 border border-l-0 border-stone-200 rounded-r px-1.5 py-1 text-stone-500 text-xs">mL</span>
                </div>
              </div>
            </div>

            <!-- Right: Save/Update indicator (hidden on narrow, shown on wide) -->
            <div class="hidden sm:block self-start pt-1">
              <button
                @click="saveSetup()"
                x-show="!isCurrentSetupSaved()"
                class="text-xs text-stone-400 hover:text-teal-600 flex items-center gap-1 transition-colors"
              >
                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z"/>
                </svg>
                Save as new
              </button>
              <button
                @click="updateSetup()"
                x-show="isCurrentSetupSaved() && hasUnsavedDoseChange()"
                class="text-xs text-stone-400 hover:text-teal-600 flex items-center gap-1 transition-colors"
              >
                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                </svg>
                Save changes
              </button>
              <div x-show="isCurrentSetupSaved() && !hasUnsavedDoseChange()" class="text-xs text-teal-600 flex items-center gap-1">
                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                </svg>
                Saved
              </div>
            </div>
          </div>
          <!-- Warning for volume exceeding vial capacity -->
          <div x-show="waterMl > 3.5" class="flex items-center justify-center gap-2 text-xs text-amber-600 mt-1">
            <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
            </svg>
            <span>Exceeds standard 3mL vial capacity (max 3.5mL)</span>
          </div>
        </div>

        <!-- Main Calculator - Combined Card -->
        <div class="bg-gradient-to-b from-stone-50 to-teal-50 border-y border-stone-200">
            <!-- Dose Input Section -->
            <!-- Regular peptide dose input -->
            <div x-show="!isBlend" class="px-3 sm:px-4 pt-2 pb-3 flex flex-col gap-1">
              <!-- Label always on own row -->
              <div class="text-xs text-stone-500 font-medium">Dosing calculation</div>
              <!-- Dose selector -->
              <div class="flex flex-wrap items-center justify-center gap-2">
                <span class="text-sm text-stone-500">For</span>
                <button @click="currentDose = Math.max(0.25, Math.round((currentDose - 0.25) * 4) / 4)"
                  class="w-6 h-6 rounded-full bg-white border border-stone-200 hover:border-teal-400 hover:bg-teal-50 flex items-center justify-center text-stone-400 hover:text-teal-600 text-sm font-medium flex-shrink-0 transition-colors shadow-sm">−</button>
                <div class="flex items-center gap-1.5">
                  <div class="flex items-center">
                    <input type="text" inputmode="decimal"
                      :value="currentDose"
                      @change="currentDose = parseFloat($event.target.value) || currentDose"
                      @blur="currentDose = parseFloat($event.target.value) || currentDose"
                      class="bg-white border border-stone-200 rounded-l py-1.5 px-2 w-14 font-mono text-lg font-semibold text-center text-stone-800 focus:outline-none focus:border-teal-400"
                      placeholder="2.5">
                    <span class="bg-stone-100 border border-l-0 border-stone-200 rounded-r px-1.5 py-1.5 text-stone-500 text-xs">mg</span>
                  </div>
                  <span class="text-sm text-stone-600" x-text="peptideId === 'other' ? (customPeptideName || 'peptide') : peptide.name"></span>
                </div>
                <button @click="currentDose = Math.round((currentDose + 0.25) * 4) / 4"
                  class="w-6 h-6 rounded-full bg-white border border-stone-200 hover:border-teal-400 hover:bg-teal-50 flex items-center justify-center text-stone-400 hover:text-teal-600 text-sm font-medium flex-shrink-0 transition-colors shadow-sm">+</button>
              </div>
            </div>

            <!-- Blend stacked dose input -->
            <div x-show="isBlend" class="px-3 sm:px-4 pt-2 pb-3 flex flex-col gap-1">
              <!-- Label always on own row -->
              <div class="text-xs text-stone-500 font-medium">Dosing calculation</div>
              <!-- Dose selector -->
              <div class="flex flex-wrap items-center justify-center gap-2">
                <span class="text-sm text-stone-500">For</span>

                <!-- Minus button -->
                <button @click="currentDose = Math.max(0.25, Math.round((currentDose - 0.25) * 4) / 4); doseMin = currentDose; doseMax = currentDose"
                  class="w-6 h-6 rounded-full bg-white border border-stone-200 hover:border-teal-400 hover:bg-teal-50 flex items-center justify-center text-stone-400 hover:text-teal-600 text-sm font-medium flex-shrink-0 transition-colors shadow-sm">−</button>

                <!-- Stacked dose rows with names -->
                <div class="flex flex-col gap-1">
                  <!-- Primary peptide: dose + name -->
                  <div class="flex items-center gap-1.5">
                    <div class="flex items-center">
                      <input type="text" inputmode="decimal"
                        :value="currentDose"
                        @change="currentDose = parseFloat($event.target.value) || currentDose; doseMin = currentDose; doseMax = currentDose"
                        @blur="currentDose = parseFloat($event.target.value) || currentDose; doseMin = currentDose; doseMax = currentDose"
                        class="bg-white border border-stone-200 rounded-l py-1.5 px-2 w-14 font-mono text-base font-semibold text-center text-stone-800 focus:outline-none focus:border-teal-400">
                      <span class="bg-stone-100 border border-l-0 border-stone-200 rounded-r px-1.5 py-1.5 text-stone-500 text-xs">mg</span>
                    </div>
                    <span class="text-sm text-stone-600" x-text="blendComponents[0]?.name || ''"></span>
                  </div>
                  <!-- Secondary peptide: dose + name -->
                  <div class="flex items-center gap-1.5">
                    <div class="flex items-center">
                      <div class="bg-stone-100 border border-stone-200 rounded-l py-1.5 px-2 w-14 font-mono text-base text-center text-stone-500">
                      <span x-text="blendDoses && blendDoses[1] ? blendDoses[1] : '—'"></span>
                    </div>
                    <span class="bg-stone-100 border border-l-0 border-stone-200 rounded-r px-1.5 py-1.5 text-stone-500 text-xs">mg</span>
                  </div>
                  <span class="text-sm text-stone-500" x-text="blendComponents[1]?.name || ''"></span>
                </div>
              </div>

              <!-- Plus button -->
              <button @click="currentDose = Math.round((currentDose + 0.25) * 4) / 4; doseMin = currentDose; doseMax = currentDose"
                class="w-6 h-6 rounded-full bg-white border border-stone-200 hover:border-teal-400 hover:bg-teal-50 flex items-center justify-center text-stone-400 hover:text-teal-600 text-sm font-medium flex-shrink-0 transition-colors shadow-sm">+</button>
              </div>
            </div>

            <!-- Flow Arrow -->
            <div class="flex justify-center -my-1">
              <svg class="w-5 h-5 text-teal-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 14l-7 7m0 0l-7-7m7 7V3"/>
              </svg>
            </div>

            <!-- Draw Result Section -->
            <div class="px-4 pt-1 pb-2">
              <!-- Contextual Guidance -->
              <div class="text-center">
                <span class="text-sm text-teal-700">Draw to the </span>
                <span class="font-mono font-bold text-2xl text-teal-600" x-text="Math.round(units)"></span>
                <span class="text-sm text-teal-700"> unit mark</span>
              </div>


              <!-- Warnings -->
              <div x-show="exceedsSyringe" class="bg-amber-50 border border-amber-200 rounded-lg p-1.5 text-xs text-amber-800 text-center mt-1 mb-1">
                Exceeds syringe capacity (<span x-text="syringeSize === '0.5' ? '50' : '100'"></span> units max)
              </div>
              <div x-show="unitsTooSmall && !exceedsSyringe" class="bg-blue-50 border border-blue-200 rounded-lg p-1.5 text-xs text-blue-800 text-center mt-1 mb-1">
                Small volume – may be hard to measure precisely
              </div>

              <!-- Syringe -->
              <div class="-mx-2 flex justify-center" x-html="syringeSvg"></div>
            </div>
        </div>

        <!-- Footer -->
        <div class="px-3 sm:px-4 py-2.5 bg-stone-50">
          <div class="flex flex-wrap items-start justify-between gap-y-3">
            <div class="flex flex-col gap-1">
              <span class="text-xs text-stone-400">Syringe</span>
              <div class="flex">
                <button @click="syringeSize = '0.5'" :class="syringeSize === '0.5' ? 'bg-teal-500 text-white border-teal-500' : 'bg-white text-stone-600 border-stone-200'"
                  class="px-2.5 py-1 rounded-l border font-mono text-xs transition-colors">0.5 mL</button>
                <button @click="syringeSize = '1.0'" :class="syringeSize === '1.0' ? 'bg-teal-500 text-white border-teal-500' : 'bg-white text-stone-600 border-stone-200'"
                  class="px-2.5 py-1 rounded-r border border-l-0 font-mono text-xs transition-colors">1.0 mL</button>
              </div>
            </div>
            <div class="flex items-start gap-3 sm:gap-5">
              <div class="flex flex-col gap-0.5 sm:gap-1 text-center">
                <span class="text-[10px] sm:text-xs text-stone-400">Concentration</span>
                <!-- Single peptide -->
                <span x-show="!isBlend" class="font-mono font-medium text-stone-700 text-sm sm:text-base" x-text="fmtConc(concentration) + ' mg/mL'"></span>
                <!-- Blend: show both -->
                <span x-show="isBlend" class="font-mono font-medium text-stone-700 text-sm sm:text-base" x-text="(blendConcentrations ? fmtConc(blendConcentrations[0]) + ' / ' + fmtConc(blendConcentrations[1]) : '—') + ' mg/mL'"></span>
              </div>
              <div class="flex flex-col gap-0.5 sm:gap-1 text-center">
                <span class="text-[10px] sm:text-xs text-stone-400">Doses/Vial</span>
                <span class="font-mono font-medium text-stone-700 text-sm sm:text-base" x-text="dosesPerVial || '—'"></span>
              </div>
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>
</body>
</html>
